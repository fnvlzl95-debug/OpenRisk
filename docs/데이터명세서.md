# OpenRisk 데이터 명세서

## 개요

OpenRisk는 서울시 상권분석서비스의 공공데이터를 기반으로 상권 리스크를 분석합니다.
이 문서는 프로젝트에서 사용하는 데이터 구조, 분류 체계, 계산 로직을 정리합니다.

---

## 데이터 소스

### 1차 출처
- **서울시 상권분석서비스** (https://data.seoul.go.kr)
  - 상권 영역 (폴리곤)
  - 유동인구 데이터
  - 인구 통계 (거주/직장)
  - 분기별 업데이트

### 2차 API
- **카카오 Local API**
  - 키워드 → 좌표 변환
  - 주소 검색

---

## 데이터베이스 스키마

### 1. trade_areas (상권 영역)

| 컬럼 | 타입 | 설명 |
|------|------|------|
| id | varchar | 상권 고유 ID |
| name | varchar | 상권명 |
| district | varchar | 행정구 |
| center_lat | float8 | 중심 위도 |
| center_lng | float8 | 중심 경도 |
| polygon | geometry | 상권 영역 (PostGIS) |
| source | varchar | 데이터 출처 |
| updated_at | timestamp | 마지막 업데이트 |

**인덱스**
- `idx_trade_areas_name`: name 컬럼 (LIKE 검색용)
- `idx_trade_areas_district`: district 컬럼
- `idx_trade_areas_polygon`: polygon 컬럼 (GiST)

### 2. area_metrics (상권 지표)

| 컬럼 | 타입 | 설명 | 사용 |
|------|------|------|:----:|
| id | serial | 자동 증가 ID | - |
| area_id | varchar | 상권 ID (FK) | ✅ |
| period | varchar | 기준 기간 (YYYY-QN) | ✅ |
| resident_index | float8 | 거주 인구 지수 (만 단위) | ✅ |
| worker_index | float8 | 직장 인구 지수 (만 단위) | ✅ |
| traffic_index | float8 | 유동인구 지수 (만 단위) | ✅ |
| daypart_variance | float8 | 시간대 편차 (0-1) | ✅ |
| weekend_ratio | float8 | 주말 비중 (0-1) | ✅ |
| competition_density | float8 | 경쟁 밀도 | ✅ |
| open_close_churn | float8 | 개폐업률 | ✅ |
| cost_proxy | float8 | 비용 프록시 | ✅ |

**인덱스**
- `idx_area_metrics_area_id`: area_id 컬럼
- `idx_area_metrics_period`: period 컬럼

### 3. area_anchors (앵커 시설) - Phase 2-C

| 컬럼 | 타입 | 설명 |
|------|------|------|
| id | serial | 자동 증가 ID |
| area_id | varchar | 상권 ID (FK) |
| anchor_type | varchar | 시설 유형 (subway/university/hospital) |

### 4. area_change_indicators (상권변화지표) - Phase 2-C

| 컬럼 | 타입 | 설명 |
|------|------|------|
| id | serial | 자동 증가 ID |
| area_id | varchar | 상권 ID (FK) |
| period | varchar | 기준 기간 (YYYY-QN) |
| indicator | varchar | 변화 지표 (LL/LH/HL/HH) |

### 5. RPC 함수

#### find_area_by_point(p_lat, p_lng)
좌표 기반 상권 검색

```sql
-- 1순위: 폴리곤 내부에 포함된 상권
-- 2순위: 가장 가까운 상권 (500m 이내)
```

---

## 등급 체계

### 4단계 등급 시스템

| 등급 | 명칭 | 설명 | 특성 |
|------|------|------|------|
| A | A_주거 | 주거 밀집, 안정적 수요 | 변동성 낮음, 단골 기반 |
| B | B_혼합 | 직주 혼합, 시간대별 전략 필요 | 직장인+거주민 균형 |
| C | C_상업 | 상업 중심, 고위험 고수익 | 유동인구↑ 경쟁↑ 비용↑ |
| D | D_특수 | 관광/이벤트 특화 | 주말 비중 50% 이상 |

### 등급 결정 로직 (Phase 2: 8지표 사용)

각 등급에 대한 점수를 계산하고, 가장 높은 점수의 등급이 최종 등급이 됩니다.
자세한 계산 공식은 `등급계산로직.md`를 참조하세요.

```typescript
// 정규화된 8개 지표로 등급별 점수 계산
A_score = f(worker, variance, cost, churn)     // 안정성 기반
B_score = f(workerResidentBalance, ...)        // 균형 기반
C_score = f(traffic, competition, churn, cost) // 상업성 기반
D_score = f(weekend)                           // 주말 비중 기반

// 최고 점수 등급 선택
finalGrade = argmax(A_score, B_score, C_score, D_score)
```

### 등급별 해석

#### A등급 (주거형)
- **핵심 해석**
  - 주거 중심 상권으로 유동인구 변동이 적습니다
  - 단골 중심 소비 패턴이 관찰되는 구조입니다
  - 임대료 변동성이 상대적으로 낮은 편입니다

- **확인할 사항**
  - 주변 생활 밀착형 업종 구성 확인하기
  - 기존 단골 기반 업체들의 운영 기간 파악하기
  - 주민 소비 패턴과 니즈 사전 조사하기

- **리스크 요인**
  - 유동인구 기반 신규 유입이 제한적일 수 있습니다
  - 업종 전환 시 기존 고객 이탈 가능성이 있습니다

#### B등급 (혼합형)
- **핵심 해석**
  - 직장인과 거주민이 혼합된 복합 상권입니다
  - 시간대별 고객층 변화가 관찰되는 구조입니다
  - 시간대별 전략 수립이 가능한 상권입니다

- **확인할 사항**
  - 오전/점심/저녁 시간대별 유동 패턴 파악하기
  - 주중과 주말의 고객층 차이 분석하기
  - 주변 직장/거주 시설 분포 확인하기

- **리스크 요인**
  - 타겟 고객 설정이 명확하지 않으면 양쪽 모두 놓칠 수 있습니다
  - 시간대별 운영 전략에 따라 운영 복잡도가 증가할 수 있습니다

#### C등급 (상업형)
- **핵심 해석**
  - 유동인구가 많은 상업 중심 상권입니다
  - 경쟁 밀도가 높고 트렌드 변화가 빠른 편입니다
  - 매출 기대와 리스크가 모두 높은 구조입니다

- **확인할 사항**
  - 동종/유사 업종의 경쟁 현황 파악하기
  - 최소 6개월 고정비 자금 계획 검토하기
  - 트렌드 변화 대응 계획 수립하기

- **리스크 요인**
  - 임대료와 권리금이 높은 편입니다
  - 트렌드 변화에 민감하게 반응하는 상권입니다
  - 마케팅 경쟁이 심화될 수 있습니다

#### D등급 (특수형)
- **핵심 해석**
  - 주말 비중이 높은 관광/이벤트 특화 상권입니다
  - 시즌성 요인에 크게 영향받는 구조입니다
  - 일반적인 상권 분석 기준이 적용되기 어렵습니다

- **확인할 사항**
  - 주요 집객 요인 및 시즌성 파악하기
  - 유사 특수 상권 사례 분석하기
  - 비수기 운영 전략 수립하기

- **리스크 요인**
  - 시즌에 따른 매출 변동이 클 수 있습니다
  - 일반 상권 분석 기준 적용이 어려울 수 있습니다

---

## 지표 계산

### 1. 유동인구 지수 (traffic_index)

```
traffic_index = 분기 총 유동인구 / 10000
```

- 단위: 만 명
- 예: traffic_index = 406.7 → 406.7만 명/분기

### 2. 시간대 편차 (daypart_variance)

```
daypart_variance = std(시간대별 유동인구) / mean(시간대별 유동인구)
```

- 범위: 0-1
- 0에 가까울수록: 시간대별 유동인구 균일 (주거형)
- 1에 가까울수록: 시간대별 편차 큼 (상업형)

### 3. 주말 비중 (weekend_ratio)

```
weekend_ratio = 주말 유동인구 / 전체 유동인구
```

- 범위: 0-1
- 0.2-0.3: 평일 중심 (오피스)
- 0.4-0.5: 균형
- 0.5 이상: 주말 중심 (상업/관광)

### 4. 표시용 지표 변환

```typescript
// 총 유동인구
traffic_total = traffic_index * 10000  // 명 단위

// 주말 유동인구
traffic_weekend = traffic_total * weekend_ratio

// 평일 유동인구
traffic_weekday = traffic_total - traffic_weekend
```

---

## 검색 흐름

### 1. 좌표 기반 검색 (우선)

```
사용자 입력 ("홍대")
    ↓
카카오 Local API (키워드 → 좌표)
    ↓
Supabase RPC: find_area_by_point(lat, lng)
    ↓
폴리곤 포함 상권 반환 (또는 nearest)
```

### 2. 이름 기반 검색 (폴백)

```
사용자 입력 ("홍대")
    ↓
AREA_ALIASES 매핑 ("홍대입구역", "홍대입구역 1번", ...)
    ↓
DB ILIKE 검색
    ↓
우선순위 필터 (마포구, 강남구 등)
```

### 키워드 별칭

```typescript
const AREA_ALIASES = {
  '홍대': ['홍대입구역', '홍대입구역 1번', '홍대입구역 2번'],
  '강남': ['강남역', '강남역 1번', '강남역(2호선)'],
  '신촌': ['신촌역', '신촌역(2호선)', '신촌로터리'],
  '이태원': ['이태원역', '이태원로'],
  '합정': ['합정역', '합정역(2호선)'],
  '망원': ['망원역', '망원동'],
  '성수': ['성수역', '성수동']
}
```

---

## 응답 구조

### AnalysisResult (Phase 2-C)

```typescript
interface AnalysisResult {
  area: {
    id: string           // "1001"
    name: string         // "홍대입구역 1번"
    district: string     // "마포구"
    center: {
      lat: number        // 37.5563
      lng: number        // 126.9220
    }
    polygon?: GeoJSONPolygon | null  // 상권 영역 폴리곤
  }

  rawMetrics: {
    period: string             // "20253"
    traffic_total: number      // 4067000
    traffic_weekday: number    // 2723000
    traffic_weekend: number    // 1344000
    resident_index: number     // 1.74
    worker_index: number       // 0.72
  }

  dataQuality: {
    availableMetrics: number   // 8
    totalMetrics: number       // 8
    coverage: 'high' | 'medium' | 'low'
  }

  analysis: {
    grade: 'A' | 'B' | 'C' | 'D'
    gradeName: string          // "B_혼합"
    description: string        // "직주 혼합 상권, 시간대별 고객층 상이"
    reasons: Array<{
      key: string              // "traffic"
      value: number            // 0.4067
      label: string            // "유동인구 지수"
    }>
    // Phase 2-C 추가 지표
    anchors: {
      subway: boolean
      university: boolean
      hospital: boolean
    }
    changeIndicator: 'LL' | 'LH' | 'HL' | 'HH' | null
    marketingElasticity: 'HIGH' | 'MEDIUM' | 'LOW'
  }

  interpretation: {
    coreCopy: string[]         // 핵심 해석
    actions: string[]          // 확인할 사항
    risks: string[]            // 리스크 요인
  }
}
```

### 변경 이력
- Phase 2-C: `lv3_5` → `analysis` + `interpretation` 분리
- Phase 2-C: `confidence`, `difficulty`, `subTitle` 제거
- Phase 2-C: `dataQuality` 추가 (데이터 커버리지)
- Phase 2-C: `anchors`, `changeIndicator`, `marketingElasticity` 추가

---

## 데이터 업데이트

### 주기
- 서울시 상권분석서비스: **분기별** 업데이트
- 권장 동기화: 분기 시작 후 1개월 내

### 업데이트 항목
1. `area_metrics` 테이블에 새 period 데이터 INSERT
2. 신규 상권 발생 시 `trade_areas` 추가

### 데이터 품질 체크
- `traffic_index` NULL 체크
- `daypart_variance` 범위 검증 (0-1)
- `weekend_ratio` 범위 검증 (0-1)

---

## 향후 확장 계획

### 완료된 항목 (Phase 2-C)
- ✅ 8지표 등급 계산 (기본 3개 → 확장 8개)
- ✅ 앵커 시설 (지하철/대학/병원) 반영
- ✅ 상권변화지표 (LL/LH/HL/HH) 반영
- ✅ 마케팅 탄력성 지수 (HIGH/MEDIUM/LOW)
- ✅ 데이터 커버리지 표시

### 예정 항목
- ⏳ 업종별 가중치 차등 적용
- ⏳ 시계열 트렌드 분석 (전분기 대비 변화)
- ⏳ Lv4: 로컬 신호 (네이버/카카오 데이터) 연동

### 추가 데이터 소스 (검토 중)
- 카드 결제 데이터
- 배달 주문 데이터
- 소셜 미디어 트렌드
- 부동산 시세
