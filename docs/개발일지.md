# OpenRisk 개발 일지

## 2026-01-07 게시판 기능 구현

### 개요
OpenRisk 서비스에 커뮤니티 게시판 기능 추가. 카카오 OAuth 로그인, 게시글/댓글 CRUD, 관리자 공지 기능 포함.

### 완료된 작업

#### 1. Supabase 인증 시스템 (@supabase/ssr)

**생성된 파일:**
| 파일 | 역할 |
|------|------|
| `lib/supabase/client.ts` | 브라우저용 Supabase 클라이언트 |
| `lib/supabase/server.ts` | 서버 컴포넌트/라우트용 클라이언트 |
| `lib/supabase/admin.ts` | service_role 클라이언트 (조회수 증가 등) |
| `middleware.ts` | 세션 프록시 + 보호 경로 체크 |
| `app/auth/callback/route.ts` | 카카오 OAuth 콜백 핸들러 |

**인증 흐름:**
1. 사용자가 "카카오 로그인" 클릭
2. 카카오 OAuth 페이지로 리다이렉트
3. 인증 완료 후 `/auth/callback`으로 리다이렉트
4. 세션 쿠키 설정 및 게시판으로 이동

#### 2. API 라우트 (게시글/댓글 CRUD)

**생성된 파일:**
| 파일 | Method | 설명 |
|------|--------|------|
| `app/api/board/posts/route.ts` | GET/POST | 게시글 목록, 작성 |
| `app/api/board/posts/[id]/route.ts` | GET/DELETE | 게시글 상세, 삭제 |
| `app/api/board/comments/route.ts` | POST | 댓글 작성 |
| `app/api/board/comments/[id]/route.ts` | DELETE | 댓글 삭제 |

**보안 처리:**
- 입력값 sanitize (HTML 태그 제거)
- 길이 제한 (제목 100자, 내용 5000자, 댓글 500자)
- Rate Limiting (게시글 5개/시간, 댓글 20개/시간)
- 권한 검증 (작성자 또는 관리자만 삭제 가능)

#### 3. 게시판 UI (Skin-B 스타일)

**생성/수정된 파일:**
| 파일 | 역할 |
|------|------|
| `app/board/page.tsx` | 게시판 목록 페이지 |
| `app/board/write/page.tsx` | 글쓰기 페이지 |
| `app/board/[id]/page.tsx` | 게시글 상세 + 댓글 |
| `components/board/AuthButton.tsx` | 카카오 로그인/로그아웃 버튼 |

**UI 특징:**
- Skin-B 스타일 적용 (신문 느낌, `#FAFAF8` 배경, 검정 테두리)
- 모바일/데스크톱 반응형 레이아웃
- 공지글 상단 고정 (검정 배경 "공지" 뱃지)
- 관리자 표시 (테두리 "관리자" 뱃지)
- 댓글 수 표시 `[5]`

#### 4. 유틸리티

**생성된 파일:**
| 파일 | 역할 |
|------|------|
| `lib/board/validation.ts` | 입력값 sanitize, 길이 검증 |
| `lib/board/view-tracker.ts` | 조회수 중복 방지 (24시간) |
| `lib/board/rate-limiter.ts` | Rate Limiting (쿠키 기반) |

#### 5. Supabase 데이터베이스 스키마

**테이블:**
- `profiles`: 사용자 프로필 (카카오 연동)
- `posts`: 게시글
- `comments`: 댓글
- `blocked_users`: 차단 사용자
- `reports`: 신고

**뷰 (Soft Delete 안전 패턴):**
- `active_posts`: 삭제되지 않은 게시글 + 작성자 정보
- `active_comments`: 삭제되지 않은 댓글 + 작성자 정보

**보안 정책 (RLS):**
- Soft delete만 허용 (DELETE 정책 없음)
- 차단 체크를 INSERT/UPDATE에 통합
- `is_admin` 컬럼 변경 방지 (`REVOKE UPDATE`)
- `increment_view_count` RPC는 service_role만 실행 가능

### 수정/생성된 파일 요약

| 파일 | 작업 |
|------|------|
| `lib/supabase/client.ts` | 신규 |
| `lib/supabase/server.ts` | 신규 |
| `lib/supabase/admin.ts` | 신규 |
| `middleware.ts` | 신규 |
| `app/auth/callback/route.ts` | 신규 |
| `app/api/board/posts/route.ts` | 신규 |
| `app/api/board/posts/[id]/route.ts` | 신규 |
| `app/api/board/comments/route.ts` | 신규 |
| `app/api/board/comments/[id]/route.ts` | 신규 |
| `lib/board/validation.ts` | 신규 |
| `lib/board/view-tracker.ts` | 신규 |
| `lib/board/rate-limiter.ts` | 신규 |
| `components/board/AuthButton.tsx` | 신규 |
| `app/board/page.tsx` | 신규 |
| `app/board/write/page.tsx` | 신규 |
| `app/board/[id]/page.tsx` | 신규 |
| `docs/specs/02_게시판구현계획.md` | 신규 |

### 환경 변수

```bash
# .env.local에 추가 필요
SUPABASE_SERVICE_ROLE_KEY=eyJ...  # service_role 키 (조회수 증가용)
```

### 남은 작업

- [ ] 관리자 설정 (profiles 테이블에서 `is_admin = true` 설정)
- [ ] 카카오 OAuth account_email 권한 문제 해결 (비즈앱 전환 또는 Supabase 설정 확인)

---

## 2026-01-05 유동인구 지수 개선 및 상권유형 툴팁

### 개요
유동인구 등급 기준을 백분위 기반으로 통일하고, 앵커시설 검색 반경 조정, 상권유형 설명 툴팁 추가

### 완료된 작업

#### 1. 유동인구 등급 기준 통일 (백분위 기반)

기존에 3개 파일에서 서로 다른 기준값을 사용하던 문제 해결

**변경 전 (불일치):**
- `riskEngine.ts`: 25/50/80
- `traffic-index.ts`: 25/50/80/120
- `conditions.ts`: 20/50

**변경 후 (통일):**
| 레벨 | 지수 | 백분위 | 의미 |
|------|------|--------|------|
| `very_low` | ≤1 | 하위 25% | 거의 없음 |
| `low` | 2~6 | 25~75% | 적음 (주거지) |
| `medium` | 7~13 | 75~90% | 보통 (소규모 상권) |
| `high` | 14~40 | 90~99% | 많음 (역세권) |
| `very_high` | >40 | 상위 1% | 매우 많음 (강남/가산급) |

**수정 파일:**
- `lib/v2/riskEngine.ts`: NORMALIZATION.traffic 임계값
- `lib/v2/traffic-index.ts`: getTrafficLevel 함수
- `lib/v2/interpretations/conditions.ts`: getTrafficLevelSimple 함수

#### 2. 앵커시설 검색 반경 축소

도보 15분(1.2km) 기준으로 현실적인 반경 적용

| 앵커 | 변경 전 | 변경 후 | 근거 |
|------|---------|---------|------|
| 스타벅스 | 1,000m | 800m | 도보 10분 |
| 대형마트 | 2,000m | 1,200m | 도보 15분 |
| 백화점 | 2,000m | 1,200m | 도보 15분 |
| 지하철 (역세권) | 무제한 | 1,200m | 도보 15분 제한 |

**수정 파일:** `app/api/v2/analyze/route.ts`

#### 3. 트래픽 리스크 조정값 완화

유동인구가 리스크에 미치는 영향을 현실적으로 조정

| 레벨 | 변경 전 | 변경 후 |
|------|---------|---------|
| very_high | -10 | -5 |
| high | -5 | -3 |
| medium | 0 | 0 |
| low | +5 | +3 |
| very_low | +10 | +5 |

**수정 파일:** `lib/v2/closure-risk.ts`

#### 4. 상권유형 툴팁 추가

상권유형 카드에 물음표(?) 아이콘 클릭시 설명 팝업 표시

**UI 구성:**
- 2x2 그리드 레이아웃
- 각 유형별 배경색 적용 (카드와 동일)
- 모바일: 화면 중앙 오버레이
- 터치/클릭으로 닫기

**설명 내용:**
| 유형 | 설명 |
|------|------|
| A 주거 | 동네 · 단골 |
| B 혼합 | 주거+상업 |
| C 상업 | 경쟁↑ 임대↑ |
| D 특수 | 관광 · 오피스 |

**수정 파일:** `app/result-b/page.tsx`

#### 5. 레이더 차트 트래픽 리스크 계산 수정

백분위 기반 임계값에 맞춰 차트 계산 로직 업데이트

```typescript
const trafficRisk = metrics.traffic.index >= 40
  ? 20   // 상위 1% - 최소 리스크
  : metrics.traffic.index >= 13
    ? 35   // 상위 10%
    : metrics.traffic.index >= 6
      ? 50   // 상위 25%
      : Math.round(100 - (metrics.traffic.index / 6) * 50)
```

### 수정/생성된 파일

| 파일 | 작업 |
|------|------|
| `lib/v2/riskEngine.ts` | NORMALIZATION.traffic 임계값 수정 |
| `lib/v2/traffic-index.ts` | getTrafficLevel 백분위 기반으로 변경 |
| `lib/v2/interpretations/conditions.ts` | getTrafficLevelSimple 기준 통일 |
| `lib/v2/closure-risk.ts` | TRAFFIC_RISK_ADJUSTMENT 완화 |
| `app/api/v2/analyze/route.ts` | 앵커시설 검색 반경 축소 |
| `app/result-b/page.tsx` | 상권유형 툴팁 추가, 차트 계산 수정 |

### 커밋 내역
1. `feat: 유동인구 지수 백분위 기반 개선 및 상권유형 툴팁 추가`

---

## 2026-01-04 UI 개선 및 공유 기능 추가

### 개요
skin-b 스킨 기반 UI 개선 및 카카오톡 공유 기능 구현

### 완료된 작업

#### 1. 카카오톡 공유 기능 구현
ShareModal 컴포넌트 개발 및 카카오 JS SDK 연동

**구현 내용:**
- 카카오 JS SDK 전역 로드 (`app/layout.tsx`)
- ShareModal 컴포넌트 (`components/skin-b/ShareModal.tsx`)
- 카카오톡 피드 공유 (제목, 설명, 이미지, 버튼)
- 링크 복사 기능 (클립보드 API)

**카카오 SDK 설정:**
```typescript
const KAKAO_JS_KEY = '3e682108baedad97b96ccde241977838'
window.Kakao.init(KAKAO_JS_KEY)
window.Kakao.Share.sendDefault({...})
```

#### 2. 좁은 화면 레이아웃 깨짐 수정
갤럭시 구형 모델 등 가로폭이 좁은 기기에서 검색창 레이아웃 깨지는 문제 해결

**수정 내용:**
| 요소 | 추가된 클래스 | 역할 |
|------|-------------|------|
| input | `min-w-0` | flex 자식이 콘텐츠보다 작아질 수 있게 허용 |
| button | `flex-shrink-0` | 버튼 크기 고정 (줄어들지 않음) |
| container | `overflow-x-hidden` | 가로 스크롤 방지 |

#### 3. 데이터 기준일 정리
- footer에서 데이터 기준일 텍스트 제거
- `docs/specs/06_데이터기준일.md` 문서 업데이트

#### 4. 이미지 저장 기능 (시도 후 제거)
html2canvas → dom-to-image-more로 교체 시도
- Tailwind CSS v4의 `lab()` 색상 함수 미지원 문제 발생
- 호환성 문제로 기능 제거

### 수정/생성된 파일

| 파일 | 작업 |
|------|------|
| `app/layout.tsx` | 카카오 JS SDK 스크립트 추가 |
| `components/skin-b/ShareModal.tsx` | 공유 모달 컴포넌트 생성 |
| `app/home-b/page.tsx` | 반응형 레이아웃 수정 (min-w-0, flex-shrink-0) |
| `app/result-b/page.tsx` | ShareModal 연동, 데이터 기준일 텍스트 제거 |
| `lib/kakao-maps.d.ts` | Kakao JS SDK 타입 정의 추가 |
| `docs/specs/06_데이터기준일.md` | 문서 업데이트 |

### 커밋 내역
1. `feat: skin-b 디자인 개선 및 기능 업데이트`
2. `feat: 카카오톡 공유 모달 구현 및 SDK 설정 수정`
3. `feat: 공유 모달에 이미지 저장 기능 추가`
4. `fix: 이미지 캡처 라이브러리를 dom-to-image-more로 교체`
5. `refactor: 이미지 저장 기능 제거`
6. `fix: 좁은 화면에서 검색창 레이아웃 깨짐 수정`

---

## 2026-01-03 (2차) 리스크 카드 시스템 도입

### 개요
기존 "→" 화살표 연결 문장 → 카드 기반 UI로 전환
- 시각적 계층 구조로 가독성 향상
- Top 3 우선순위로 핵심 리스크만 집중
- 현장 확인 질문으로 행동 유도

### 완료된 작업

#### 1. RiskCard 타입 시스템 (`lib/v2/types.ts`)
```typescript
interface RiskCard {
  id: string
  flag: string              // 레드플래그 타이틀 (7~12자)
  warning: string           // 경고 한 줄 (30자 이내)
  evidenceBadges: EvidenceBadge[]  // 근거 뱃지 (최대 3개)
  fieldQuestion: string     // 현장 확인 질문
  severity: 'critical' | 'warning' | 'caution'
  priority: number          // 우선순위 (낮을수록 중요)
}
```

#### 2. 카드 템플릿 시스템 (`lib/v2/interpretations/risk-cards.ts`)
조건 기반 카드 생성 로직:
- 경쟁 관련: `comp_high_traffic_low`, `comp_zero`, `comp_high` 등
- 임대료 관련: `cost_high_comp_high`, `cost_low_trap` 등
- 생존율 관련: `survival_critical`, `survival_high` 등
- 유동인구: `traffic_low_no_anchor`, `traffic_night_heavy` 등
- 조합 카드: `worst_triple` (3중 리스크)

#### 3. UI 컴포넌트 (`components/v2/RiskCardStack.tsx`)
다크 테마 대응 카드 스택:
- 심각도별 색상: critical(빨강), warning(노랑), caution(회색)
- 근거 뱃지: metric/data/trend 타입별 스타일
- 현장 확인 질문 영역

#### 4. API 응답 확장 (`app/api/v2/analyze/route.ts`)
`riskCards` 필드 추가 (Top 3 자동 생성)

#### 5. result-v2 페이지 통합
기존 "핵심 해석" 텍스트 → RiskCardStack 컴포넌트로 교체

### 카드 구조 예시
```
┌─────────────────────────────────────┐
│ 🔴 #1 파이 쪼개기 구조               │
├─────────────────────────────────────┤
│ 12개가 적은 손님 두고 경쟁           │
│ ┌────────┐ ┌────────────┐           │
│ │동종 12개│ │유동 낮음   │           │
│ └────────┘ └────────────┘           │
├─────────────────────────────────────┤
│ 👉 "왜 이렇게 많이 열었는데 손님이   │
│    없는지" 주변 가게에 물어보세요    │
└─────────────────────────────────────┘
```

### 수정/생성된 파일
| 파일 | 작업 |
|------|------|
| `lib/v2/types.ts` | RiskCard, EvidenceBadge 타입 추가 |
| `lib/v2/interpretations/risk-cards.ts` | 신규 - 카드 템플릿 시스템 |
| `components/v2/RiskCardStack.tsx` | 신규 - 다크테마 카드 UI |
| `app/api/v2/analyze/route.ts` | riskCards 필드 추가 |
| `app/result-v2/page.tsx` | RiskCardStack 통합 |

---

## 2026-01-03 생존지표 개선 및 폐업률 데이터 임포트

### 완료된 작업

#### 1. 생존지표(SurvivalMetrics) 확장
폐업/개업 트렌드 기반 리스크 신호 추가

| 신규 필드 | 타입 | 설명 |
|----------|------|------|
| `trend` | 'growing' \| 'stable' \| 'shrinking' | 점포 증감 트렌드 |
| `trendLabel` | string | "늘어나는 시장", "안정적", "줄어드는 시장" |
| `riskLabel` | string | "높은", "보통", "낮은" |
| `summary` | string | "개업 12% / 폐업 8% · 순증가" |

트렌드 판정 기준:
- `growing`: 순증가 (개업률 > 폐업률)
- `shrinking`: 순감소 (폐업률 > 개업률)
- `stable`: 기타

#### 2. 폐업률 데이터 임포트 API 추가
`/api/admin/import-closure` 신규 개발

**기능:**
- 2024.12 vs 2025.10 점포 데이터 비교
- H3 그리드(resolution 9)별 개업/폐업 수 계산
- `grid_store_counts` 테이블에 `closure_count`, `opening_count` 필드 업데이트

**계산 로직:**
```typescript
// 개업: 2025.10에만 존재하는 점포
const newStores = currentStores.filter(s => !prevStoreIds.has(s.id))

// 폐업: 2024.12에만 존재하는 점포
const closedStores = prevStores.filter(s => !currentStoreIds.has(s.id))
```

#### 3. 해석 문장 3단계 구조 도입
`templates.ts` 전면 개편 - 관측→해석→실패메커니즘 구조

| 단계 | 필드 | 역할 | 예시 |
|------|------|------|------|
| 1 | `observation` | 데이터 수치 확인 | "동종 업체가 ${sameCategory}개예요" |
| 2 | `interpretation` | 의미/영향 해석 | "경쟁이 치열해서 차별화가 필요해요" |
| 3 | `failureMechanism` | 실패 시나리오 | "비슷한 가게가 많으면 손님이 분산돼요" |

#### 4. 19개 업종별 특화 템플릿 완성
모든 업종에 대해 7대 지표별 맞춤 해석 문장 완성

**업종 목록:**
- 음식점 (7): 한식, 양식, 일식, 중식, 치킨, 피자, 패스트푸드
- 카페/베이커리 (3): 카페, 베이커리, 디저트
- 주점 (1): 바/술집
- 소매 (2): 편의점, 슈퍼마켓
- 서비스 (4): 미용실, 네일샵, 세탁소, 약국
- 기타 (2): 헬스장, 학원

#### 5. 데이터 정합성 검증 (카카오맵 비교)
이태원 500m 양식점 개수 비교

| 출처 | 개수 | 비고 |
|------|------|------|
| OpenRisk API | 153개 | 소상공인 공식 데이터 (2025.10) |
| Kakao Map | 45개 | 키워드 검색 결과 |

**차이 원인:**
- OpenRisk: 배달전문점, 미등록 업체 포함
- Kakao: 검색 노출 업체만 포함

### 수정/생성된 파일

| 파일 | 작업 |
|------|------|
| `app/api/admin/import-closure/route.ts` | 신규 - 폐업/개업 데이터 임포트 |
| `app/api/v2/analyze/route.ts` | buildSurvivalLabels() 추가 |
| `components/v2/SurvivalCard.tsx` | trend/trendLabel/riskLabel/summary 사용 |
| `lib/v2/interpretations/templates.ts` | 3단계 구조 + 19개 업종 특화 |
| `lib/v2/interpretations/generator.ts` | generateSummary() 업데이트 |
| `lib/v2/interpretations/types.ts` | 신규 - 타입 정의 분리 |
| `lib/v2/types.ts` | SurvivalMetrics 타입 확장 |
| `scripts/check-kakao-western.ps1` | 신규 - 카카오맵 비교 스크립트 |

---

## 2026-01-02 (2차) v2 프론트엔드 및 데이터 기준 정합성 개선

### 완료된 작업

#### 1. 유동인구 기준점 수정
지하철+버스 기반 추정 데이터에 맞게 기준점 조정

| 항목 | Before | After |
|------|--------|-------|
| NORMALIZATION.traffic.lowThreshold | 5,000 | 10 |
| NORMALIZATION.traffic.highThreshold | 30,000 | 40 |
| getTrafficLevel 기준 | 5000/20000 | 5/15/30/50 (5단계) |
| determineAreaType 상업지역 기준 | index > 50 | index > 30 |

#### 2. 유동인구 UI 변경
추정 데이터임을 명확히 하고 레벨 바로 표시

- 숫자 표시 → 5단계 레벨 바 (very_low ~ very_high)
- "(추정)" 라벨 추가
- 레벨별 색상: rose(낮음) / amber(보통) / emerald(높음)

#### 3. 임대료 표시 일관성 수정
"평당 임대료"임을 명확히 하고 월 임대료 계산 추가

**templates.ts 수정:**
- 기존: `'임대료가 높아요, 매일 ${avgRent}만원 이상 벌어야 본전이에요'`
- 수정: `'평당 ${avgRent}만원대로 높아요, 10평 기준 월 ${rentMonthly10}만원 이상이에요'`

**conditions.ts 수정:**
- `DynamicVars`에 `rentMonthly10` 추가
- `buildDynamicVars`에서 `avgRent * 10` 계산

#### 4. v1 코드 정리
미사용 코드 및 파일 삭제

| 삭제 항목 | 파일/폴더 |
|----------|----------|
| v1 API | `app/api/analyze/route.ts` |
| v1 결과 페이지 | `app/result/page.tsx` |
| Skin B | `app/skin-b/` |
| v1 엔진 | `lib/engine/` |
| 미사용 컴포넌트 | `components/AreaMap.tsx`, `Tooltip.tsx`, `AISummaryModal.tsx` |
| 구 계획서 | `PLAN_V1.md` → `docs/PLAN_V1_archive.md` |

### 수정된 파일
- `lib/v2/riskEngine.ts` - 유동인구 기준점 수정
- `lib/v2/interpretations/templates.ts` - 임대료 문구 수정
- `lib/v2/interpretations/conditions.ts` - rentMonthly10 변수 추가
- `app/result-v2/page.tsx` - 유동인구 레벨 바 UI
- `lib/supabase.ts` - 싱글턴 패턴 적용

---

## 2026-01-02 OpenRisk v2.0 - 7대 지표 분석 시스템

### 완료된 작업

#### 1. v2 API 신규 개발 (`/api/v2/analyze`)
기존 상권 기반 분석에서 **포인트 기반 H3 그리드 분석**으로 전환

| 항목 | v1 | v2 |
|------|-----|-----|
| 분석 단위 | 상권 폴리곤 | H3 헥사곤 그리드 (해상도 9) |
| 입력 | 상권 코드 | 좌표 (lat, lng) + 업종 |
| 지표 수 | 8개 | 7대 핵심 지표 |
| 커버리지 | 서울 | 서울/경기/인천 |

#### 2. 7대 지표 구현

| # | 지표 | 데이터 소스 | 파일 |
|---|------|------------|------|
| 1 | 경쟁 밀도 | grid_store_counts (소상공인 CSV) | riskEngine.ts |
| 2 | 유동인구 지수 | 지하철 + 버스 + POI 보정 | traffic-index.ts |
| 3 | 임대료 | 구별 평균 추정 | route.ts |
| 4 | 폐업 위험도 | 업종별 생존율 기반 추정 | closure-risk.ts |
| 5 | 앵커 시설 | 지하철 DB + 카카오 POI API | route.ts |
| 6 | 시간대 특성 | 서울 실데이터 + 경기/인천 추정 패턴 | traffic-index.ts |
| 7 | 상권 성격 | 업종 분포 기반 분류 | riskEngine.ts |

#### 3. 업종 카테고리 시스템 (`lib/categories.ts`)
19개 업종 분류 및 업종별 가중치 정의

```typescript
type BusinessCategory =
  | 'restaurant_korean' | 'restaurant_western' | 'restaurant_japanese'
  | 'restaurant_chinese' | 'restaurant_chicken' | 'restaurant_pizza'
  | 'restaurant_fastfood' | 'cafe' | 'bakery' | 'dessert' | 'bar'
  | 'convenience' | 'mart' | 'beauty' | 'nail' | 'fitness'
  | 'pharmacy' | 'laundry' | 'academy'
```

#### 4. 앵커 시설 확장 (카카오 POI API)

| 시설 | 검색 반경 | 구현 |
|------|----------|------|
| 지하철 | DB 기반 | `find_nearest_subway` RPC |
| 스타벅스 | 1km | 카카오 키워드 검색 (개수 포함) |
| 대형마트 | 2km | 이마트/홈플러스/코스트코/롯데마트 |
| 백화점 | 2km | 신세계/롯데/현대 |

#### 5. 시간대 특성 처리
1
| 지역 | 처리 방식 |
|------|----------|
| 서울 | 247개 역 실제 hourly_data 사용 |
| 경기/인천 | 일 승객수 기반 추정 패턴 적용 |

추정 패턴 (서울 데이터 기반):
- 출퇴근형 (일 3만 이하): morning 38%, day 28%, night 34%
- 상업형 (일 10만 이상): morning 25%, day 42%, night 33%
- 혼합형 (중간): morning 30%, day 36%, night 34%

#### 6. 상권 성격 분류

| 유형 | 조건 |
|------|------|
| A_주거 | 점포 < 20개 또는 주거형 점포 비율 > 40% |
| B_혼합 | 기본값 |
| C_상업 | 유동인구 높음 + 상업 점포 비율 > 60% |
| D_특수 | 주말 비율 > 50% 또는 역세권 + 상업밀집 |

### 수정/생성된 파일

#### 신규 생성
- `app/api/v2/analyze/route.ts` - v2 분석 API
- `lib/v2/types.ts` - 타입 정의
- `lib/v2/riskEngine.ts` - 리스크 점수 계산
- `lib/v2/traffic-index.ts` - 유동인구 지수
- `lib/v2/closure-risk.ts` - 폐업 위험도 추정
- `lib/v2/index.ts` - 모듈 exports
- `lib/categories.ts` - 업종 카테고리
- `lib/h3.ts` - H3 유틸리티
- `components/CategorySelector.tsx` - 업종 선택 UI

#### 수정
- `app/page.tsx` - 업종 선택 기능 추가
- `app/skin-b/page.tsx` - 업종 선택 기능 추가

### 브랜치
- `v2-seven-metrics` 브랜치에서 개발
- main은 기존 v1 유지 (배포 중)

---

## 2026-01-01 OpenAI GPT-5-mini 마이그레이션

### 완료된 작업

#### 1. AI 모델 마이그레이션 (Groq → OpenAI)
Groq Llama 3.3 70B에서 OpenAI GPT-5-mini로 AI 요약 엔진 전환

| 항목 | Before | After |
|------|--------|-------|
| 모델 | Llama 3.3 70B | GPT-5-mini |
| 제공사 | Groq | OpenAI |
| role 파라미터 | `system` | `developer` |
| 토큰 제한 | `max_tokens` | `max_completion_tokens` |

#### 2. API 호환성 수정
GPT-5-mini 모델 요구사항에 맞게 파라미터 조정

- `role: 'system'` → `role: 'developer'` (신규 모델 권장)
- `max_tokens: 2500` → `max_completion_tokens: 2500`
- `temperature: 0.7` 제거 (gpt-5-mini는 기본값 1만 지원)
- `response_format: { type: 'json_object' }` 유지

#### 3. 런타임 안정화
Edge 런타임에서 OpenAI SDK 호환 문제 방지

```typescript
export const runtime = 'nodejs'
```

#### 4. 에러 로깅 강화
디버깅을 위한 상세 에러 로깅 추가

```typescript
console.error('AI summary error RAW:', error)
console.error('status:', error?.status)
console.error('message:', error?.message)
console.error('error body:', error?.error)
```

#### 5. AI 요약 응답 구조 강화 (v4)
더 풍부한 분석 제공을 위한 필드 추가

| 신규 필드 | 설명 |
|-----------|------|
| `opportunities` | 기회 요인 (데이터 근거 포함) |
| `idealBusiness` | 적합 업종 특성 (업종명 직접 추천 X) |

### Vercel 환경 변수

```
NEXT_PUBLIC_KAKAO_MAP_KEY
KAKAO_REST_KEY
NEXT_PUBLIC_SUPABASE_URL
NEXT_PUBLIC_SUPABASE_ANON_KEY
SUPABASE_SERVICE_KEY
OPENAI_API_KEY
```

### 수정된 파일
- `app/api/ai/summary/route.ts` - OpenAI 마이그레이션, 에러 로깅 강화
- `components/AISummaryModal.tsx` - opportunities, idealBusiness 섹션 추가
- `docs/AI프롬프트명세서.md` - OpenAI/GPT-5-mini 기준 문서 업데이트

---

## 2025-12-31 (2차) AI 프롬프트 v1.2 개선

### 완료된 작업

#### 1. AI 프롬프트 v1.1 패치
전문가 피드백 반영하여 4가지 이슈 해결

| 이슈 | 해결 |
|------|------|
| "계산 금지"가 너무 강함 | 배수/비율 계산 허용 (weekday/weekend, worker/resident) |
| traffic_total "많다/적다" 표현 어려움 | "비교 데이터 부재로 절대 평가 제한" 표현 허용 |
| 예시 문장과 규칙 충돌 | 예시 문장 수정 |
| 길이 제한 충돌 (60 vs 50자) | 60자로 통일 |

#### 2. 필드 역할 분리 (structureAnalysis vs marketingNote)
중복 방지를 위한 금지어 설정

- **structureAnalysis 금지어**: 광고, 마케팅, 노출, SNS, 플레이스, 리뷰, 검색, 바이럴, 유입, 홍보
- **marketingNote 금지어**: 주거/오피스/복합, 평일/주말, 점심/저녁, 직장인/거주민, 시간대, 배후 수요

#### 3. finalSummary 결론 카드 구조
structureAnalysis 반복 문제 해결

**새 구조 (2~3문장 고정):**
- 1문장: 구조 결론 (structureAnalysis 압축, 동일 표현 금지)
- 2문장: riskChecks 2개를 "원인→리스크"로 압축
- 3문장: nextSteps 2개를 "확인 필요" 체크리스트로 요약

#### 4. marketingNote 조건부 null
- 템플릿에서 `"marketingNote": null`로 기본값 설정
- marketingElasticity가 null이면 반드시 null
- grade D 또는 grade 없음이면 null

#### 5. 프롬프트 안정화 패치
- 이스케이프 정리: `\\"` → `\"`
- finalSummary 표현 허용 범위 명시: 압축·재조합·동의어 치환·순서 변경

### 새 문서
- `docs/AI프롬프트명세서.md` - AI 프롬프트 구조 및 규칙 문서화

### 수정된 파일
- `app/api/ai/summary/route.ts` - 프롬프트 v1.2 적용

---

## 2025-12-31 (1차) Skin 1 UI 개선 및 마진 조정

### 완료된 작업

#### 1. 타이틀 변경
Skin 1 메인 페이지 타이틀을 Skin 2와 동일하게 변경

- "오픈리스크" → "상권의 진실을 마주하세요."
- 서브타이틀: "서울시 빅데이터 기반 상권 리스크 분석 엔진"

#### 2. 뷰포트 최적화를 위한 마진 조정
초기 화면에서 핵심 콘텐츠가 보이도록 컴팩트한 레이아웃 적용

| 구간 | Before | After |
|------|--------|-------|
| 히어로 → 검색폼 | mb-8 sm:mb-12 | mb-6 sm:mb-10 |
| 검색폼 → 예시 | mb-8 sm:mb-10 | mb-6 sm:mb-8 |
| 예시 → 등급체계 | mb-10 sm:mb-12 | mb-6 sm:mb-8 |
| 등급체계 라벨 → 카드 | mb-4 sm:mb-6 | mb-2 sm:mb-3 |
| 등급카드 → 통계 | mt-10 sm:mt-16 | mt-6 sm:mt-10 |

#### 3. 가독성 개선 (이전 세션)
- Skin 1 폰트 크기 증가 (text-base 기준)
- 명도 대비 개선 (text-zinc-400 → 적정 대비율 확보)

### 수정된 파일
- `app/page.tsx` - 타이틀 변경, 마진 조정

---

## 2025-12-30 (3차) 툴팁 시스템 및 모바일 UX 개선

### 완료된 작업

#### 1. 툴팁 컴포넌트 구현 (`components/Tooltip.tsx`)
마우스 호버 시 설명을 표시하는 툴팁 컴포넌트 개발

- React Portal 사용 (overflow 클리핑 방지)
- 위치 자동 조정 (화면 경계 처리)
- 테두리 있는 화살표 스타일
- 스크롤 시 자동 닫힘
- 다크 테마 적용 (`#1f1f24` 배경)

#### 2. 섹션별 툴팁 적용
결과 페이지 모든 섹션에 설명 툴팁 추가

- **인구 구성**: 거주인구/직장인구 비율 설명
- **유동인구**: 분기 유동인구 데이터 설명
- **분석 결과**: 등급/특성/마케팅탄성/상권변화 설명
- **분석 지표**: 개폐업변동/유동인구/비용압박/경쟁밀도/주말비중/시간대편차 설명
- **핵심 해석/확인사항/리스크**: 각 섹션 목적 설명
- **지도**: 상권 위치 시각화 설명

#### 3. 검색어 표시 기능
사용자가 검색한 키워드와 매칭된 상권명을 함께 표시

- API 응답에 `searchQuery` 필드 추가
- `AnalysisResult` 타입에 `searchQuery` 추가
- 상권명과 검색어가 다를 경우 "OOO 검색 결과" 표시
- 색상: `text-secondary`로 가시성 확보

#### 4. 모바일 레이아웃 개선
유동인구 숫자 줄바꿈 문제 해결

- `text-data-sm` 폰트 크기 축소 (1rem → 0.875rem)
- 숫자에 `whitespace-nowrap` 적용
- 천 단위 구분자(,) 포함 숫자 줄바꿈 방지

#### 5. 분석 지표 정리
중복 지표 제거 및 정리

- `gradeEngine.ts`에서 `worker_index` 제거 (인구 구성 섹션과 중복)
- 분석 지표: 유동인구, 개폐업변동, 비용압박, 경쟁밀도, 주말비중, 시간대편차
- 등급 유형에 따라 상위 3개 지표만 표시

#### 6. 텍스트 크기 조정
상세 정보 텍스트 크기 최적화

- 등급/특성/마케팅탄성/상권변화 값 텍스트
- `text-data-sm` → `text-body`로 변경

### 수정된 파일
- `components/Tooltip.tsx` - 툴팁 컴포넌트 (신규)
- `app/result/page.tsx` - 툴팁 적용, 검색어 표시, whitespace-nowrap
- `app/skin-b/result/page.tsx` - 검색어 표시
- `app/api/analyze/route.ts` - searchQuery 필드 추가
- `lib/types.ts` - AnalysisResult에 searchQuery 추가
- `lib/engine/gradeEngine.ts` - worker_index 제거
- `app/globals.css` - text-data-sm 모바일 폰트 크기 조정

---

## 2025-12-30 (2차) Phase 2-C 완료 및 UX 개선

### 완료된 작업

#### 1. 리스크 해석 도구로 포지셔닝 변경
서비스 목적을 "상권 컨설팅"에서 "리스크 해석 도구"로 명확히 재정의

- "추천합니다", "안전합니다" 등 주관적 표현 제거
- "~할 수 있습니다", "~인 구조입니다" 등 사실 기반 표현으로 변경
- 법적 면책 조항 추가 (등급계산로직.md 8장)

#### 2. 데이터 커버리지 지표 추가
기존 "신뢰도 %" 제거, 데이터 기반 커버리지로 대체

- `dataQuality` 필드 API 응답에 추가
- 8개 지표 중 유효 데이터 개수 표시 (예: "8/8개 지표")
- high/medium/low 3단계 커버리지 레벨
- types.ts에 `DataQuality`, `DataCoverage` 타입 추가

#### 3. copyRenderer.ts 문구 전면 개선
등급별 해석 문구를 중립적/사실 기반으로 전면 수정

- A등급: "유리한 환경" → "단골 중심 소비 패턴이 관찰되는 구조"
- 모든 등급: "추천" → "확인하기" 액션 가이드로 변경
- UI 라벨: "추천 액션" → "확인할 사항", "주의 리스크" → "리스크 요인"

#### 4. 결과 페이지 UI 라벨 변경
양쪽 스킨(기본, skin-b) 모두 적용

- `app/result/page.tsx`
- `app/skin-b/result/page.tsx`
- 데이터 커버리지 패널 추가

#### 5. 문서 파일명 한국어화
- GRADE_LOGIC.md → 등급계산로직.md
- CHANGELOG.md → 개발일지.md
- DATA_SPEC.md → 데이터명세서.md
- DATA_METRICS.md → 지표현황.md
- DATA_ENHANCEMENT.md → 데이터보강계획.md
- ACCURACY_ROADMAP.md → 정확도개선로드맵.md

---

## 2024-12-30 (1차) 엔진 분리 및 UI 개선

### 완료된 작업

#### 1. 엔진 분리 (`lib/engine/`)
로직을 별도 모듈로 분리하여 유지보수성 향상

- `lib/engine/gradeEngine.ts` - 등급 계산 로직
  - `calculateGrade()`: 유동인구, 시간대 편차, 주말 비중 기반 A-D 등급 산출
  - `calculateDisplayMetrics()`: 표시용 지표 계산

- `lib/engine/copyRenderer.ts` - 해석 문구 렌더러
  - `getGradeCopy()`: 등급별 coreCopy, actions, risks 반환
  - `getGradeSummary()`: 등급별 한 줄 요약

- `lib/engine/index.ts` - 모듈 exports

- `app/api/analyze/route.ts` 리팩토링
  - 로컬 함수 제거, 엔진 모듈에서 import

#### 2. 지도 시각화 (카카오맵)
- `components/AreaMap.tsx` 생성
  - 카카오 Maps SDK 동적 로드
  - 마커, 반경 원(300m), 상권명 오버레이 표시
  - 등급별 색상 적용

- 카카오 API 키 설정
  - `.env.local`에 `NEXT_PUBLIC_KAKAO_MAP_KEY` 추가
  - 카카오 개발자 콘솔에서 Web 플랫폼 도메인 등록

#### 3. 결과 페이지 UI 개선
- 레이아웃 재구성
  - 왼쪽: 정보카드 + 유동인구 카드 (세로 배치)
  - 오른쪽: 지도 (전체 높이)

- 정보카드 통일
  - 등급/유형/난이도/신뢰도 panel 스타일 통일
  - `flex flex-col gap-2`로 라벨-값 간격 조정
  - `text-data-sm` 폰트 스타일 통일

- 유동인구 카드
  - 총/평일/주말 3열 grid
  - 동일한 panel 스타일 적용

#### 4. 디자인 시스템 수정
- 폰트 변경: Departure Mono → Pretendard
- 색상 가시성 개선
  - `stat-label`: `--text-tertiary` → `--text-secondary`
  - `data-label`: `--text-tertiary` → `--text-secondary`
  - `stat-unit`: `--text-tertiary` → `--text-secondary`

---

## 남은 작업

### Phase 2 (단기)
- [ ] 검색 자동완성 기능
- [ ] 상권 폴리곤 시각화 (원형 → 실제 폴리곤)
- [ ] 모바일 반응형 최적화
- [ ] 로딩 스켈레톤 UI

### Phase 3 (중기)
- [ ] lv4 분석 기능 (업종별 상세 분석)
- [ ] 비교 분석 기능 (2개 상권 비교)
- [ ] 분석 결과 PDF 다운로드
- [ ] 분석 결과 공유 기능

### Phase 4 (장기)
- [ ] 사용자 인증 (로그인/회원가입)
- [ ] 분석 이력 저장
- [ ] 즐겨찾기 상권
- [ ] 알림 기능 (상권 변동 알림)

---

## 실제 서비스를 위해 필요한 것

### 인프라
- [ ] Vercel 배포 설정
- [ ] 커스텀 도메인 연결
- [ ] SSL 인증서 (자동)
- [ ] CDN 설정

### 보안
- [ ] 환경 변수 관리 (Vercel 환경 변수)
- [ ] API Rate Limiting
- [ ] CORS 설정
- [ ] CSP (Content Security Policy)

### 데이터
- [ ] 데이터 업데이트 자동화 (분기별)
- [ ] 데이터 백업 정책
- [ ] 상권 폴리곤 데이터 보강
- [ ] 업종별 데이터 추가

### 모니터링
- [ ] 에러 트래킹 (Sentry)
- [ ] 분석 도구 (Google Analytics / Vercel Analytics)
- [ ] 성능 모니터링 (Core Web Vitals)
- [ ] 사용자 피드백 수집

### 법적 요건
- [ ] 개인정보처리방침
- [ ] 이용약관
- [x] 데이터 출처 명시 (서울시 상권분석서비스) - 등급계산로직.md에 명시
- [x] 면책 조항 (투자 결정 책임) - 등급계산로직.md 8장에 추가

### SEO & 마케팅
- [ ] 메타 태그 최적화
- [ ] Open Graph 이미지
- [ ] sitemap.xml
- [ ] robots.txt
- [ ] 랜딩 페이지 콘텐츠

---

## 기술 스택

| 영역 | 기술 |
|------|------|
| Frontend | Next.js 15, React, TypeScript |
| Styling | Tailwind CSS, CSS Variables |
| Database | Supabase (PostgreSQL + PostGIS) |
| Map | Kakao Maps SDK |
| Deployment | Vercel (예정) |
| Font | Pretendard Variable |

---

## 파일 구조

```
OpenRisk/
├── app/
│   ├── api/
│   │   └── analyze/
│   │       └── route.ts      # 분석 API (searchQuery 포함)
│   ├── result/
│   │   └── page.tsx          # 결과 페이지 (툴팁 적용)
│   ├── skin-b/
│   │   └── result/
│   │       └── page.tsx      # 대체 스킨 결과 페이지
│   ├── layout.tsx            # 루트 레이아웃
│   ├── page.tsx              # 메인 페이지
│   └── globals.css           # 디자인 시스템
├── components/
│   ├── AreaMap.tsx           # 카카오맵 컴포넌트
│   └── Tooltip.tsx           # 툴팁 컴포넌트 (Portal 기반)
├── lib/
│   ├── engine/
│   │   ├── gradeEngine.ts    # 등급 계산
│   │   ├── copyRenderer.ts   # 해석 문구
│   │   └── index.ts          # exports
│   ├── types.ts              # TypeScript 타입
│   └── supabase.ts           # Supabase 클라이언트
└── docs/
    ├── 개발일지.md            # 개발 일지
    ├── 등급계산로직.md        # 등급 계산 로직 설명
    ├── 데이터명세서.md        # 데이터 구조 명세
    ├── 지표현황.md            # 사용 지표 현황
    ├── 데이터보강계획.md      # 데이터 보강 계획
    ├── 정확도개선로드맵.md    # 정확도 개선 계획
    └── AI프롬프트명세서.md    # AI 요약 프롬프트 구조 및 규칙
```
