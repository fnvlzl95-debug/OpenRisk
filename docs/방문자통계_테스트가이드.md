# ë°©ë¬¸ì í†µê³„ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ ê°€ì´ë“œ

## ğŸš€ ì„¤ì¹˜ ì™„ë£Œ!

ë‹¤ìŒ íŒŒì¼ë“¤ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤:
- âœ… `scripts/setup-visitor-stats.sql` - Supabase ì„¤ì • ìŠ¤í¬ë¦½íŠ¸
- âœ… `app/api/stats/visitor/route.ts` - ë°©ë¬¸ì ì¶”ì  API
- âœ… `app/api/stats/dashboard/route.ts` - ëŒ€ì‹œë³´ë“œ API
- âœ… `app/admin/stats/page.tsx` - ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ í˜ì´ì§€

---

## Step 1: Supabase ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •

### 1-1. Supabase Dashboard ì ‘ì†
1. https://supabase.com/dashboard ì ‘ì†
2. í”„ë¡œì íŠ¸ ì„ íƒ
3. ì¢Œì¸¡ ë©”ë‰´ì—ì„œ **SQL Editor** í´ë¦­

### 1-2. SQL ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
1. "New query" ë²„íŠ¼ í´ë¦­
2. `scripts/setup-visitor-stats.sql` íŒŒì¼ ë‚´ìš© ì „ì²´ ë³µì‚¬
3. SQL Editorì— ë¶™ì—¬ë„£ê¸°
4. **Run** ë²„íŠ¼ í´ë¦­ (ë˜ëŠ” Ctrl+Enter)

### 1-3. ì‹¤í–‰ ê²°ê³¼ í™•ì¸
ë‹¤ìŒ ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•´ì„œ í…Œì´ë¸”ì´ ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸:
```sql
SELECT * FROM visitor_stats WHERE id = 'total';
```

ê²°ê³¼:
```
id    | visit_count | unique_visitors | last_updated | created_at
------|-------------|-----------------|--------------|------------
total | 0           | 0               | 2026-01-18   | 2026-01-18
```

### 1-4. RPC í•¨ìˆ˜ í…ŒìŠ¤íŠ¸
```sql
SELECT increment_visitor_count('test-2026-01-18');
```

ê²°ê³¼:
```
increment_visitor_count
-----------------------
1
```

ë‹¤ì‹œ í™•ì¸:
```sql
SELECT * FROM visitor_stats WHERE id = 'test-2026-01-18';
```

ê²°ê³¼:
```
id               | visit_count | unique_visitors | ...
-----------------|-------------|-----------------|----
test-2026-01-18  | 1           | 1               | ...
```

âœ… **ì„±ê³µ!** ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì • ì™„ë£Œ

---

## Step 2: í™˜ê²½ ë³€ìˆ˜ í™•ì¸

`.env.local` íŒŒì¼ì— ë‹¤ìŒ ë³€ìˆ˜ë“¤ì´ ìˆëŠ”ì§€ í™•ì¸:

```bash
NEXT_PUBLIC_SUPABASE_URL=https://[í”„ë¡œì íŠ¸].supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJ...
SUPABASE_SERVICE_KEY=eyJ...  # ì¤‘ìš”: admin clientìš©
```

> **ì£¼ì˜**: `SUPABASE_SERVICE_KEY`ê°€ ì—†ìœ¼ë©´ APIì—ì„œ RPC í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!

---

## Step 3: ê°œë°œ ì„œë²„ ì‹¤í–‰

```bash
npm run dev
```

ì„œë²„ê°€ ì‹œì‘ë˜ë©´ http://localhost:3000 ì ‘ì†

---

## Step 4: API í…ŒìŠ¤íŠ¸

### 4-1. í„°ë¯¸ë„ì—ì„œ í…ŒìŠ¤íŠ¸

**GET ìš”ì²­ (í˜„ì¬ í†µê³„ ì¡°íšŒ)**
```bash
curl http://localhost:3000/api/stats/visitor
```

ì‘ë‹µ ì˜ˆì‹œ:
```json
{
  "success": true,
  "stats": {
    "visit_count": 0,
    "unique_visitors": 0,
    "last_updated": "2026-01-18T..."
  }
}
```

**POST ìš”ì²­ (ë°©ë¬¸ì ì¹´ìš´íŠ¸ ì¦ê°€)**
```bash
curl -X POST http://localhost:3000/api/stats/visitor \
  -H "Content-Type: application/json" \
  -d '{"page_path": "/test"}'
```

ì‘ë‹µ ì˜ˆì‹œ:
```json
{
  "success": true,
  "counted": true,
  "count": 1
}
```

**ëŒ€ì‹œë³´ë“œ API í…ŒìŠ¤íŠ¸**
```bash
curl http://localhost:3000/api/stats/dashboard
```

ì‘ë‹µ ì˜ˆì‹œ:
```json
{
  "success": true,
  "stats": {
    "total": 1,
    "today": 1,
    "weekly": [
      {"id": "2026-01-18", "visit_count": 1}
    ]
  }
}
```

### 4-2. ë¸Œë¼ìš°ì €ì—ì„œ í…ŒìŠ¤íŠ¸

1. http://localhost:3000/api/stats/visitor ì ‘ì†
2. ì‘ë‹µ JSON í™•ì¸
3. ìƒˆë¡œê³ ì¹¨ (F5) â†’ `visit_count`ê°€ ì¦ê°€í•˜ì§€ ì•ŠìŒ (ì¿ í‚¤ ì¤‘ë³µ ë°©ì§€)
4. ì‹œí¬ë¦¿ ëª¨ë“œë¡œ ì ‘ì† â†’ `visit_count` ì¦ê°€ í™•ì¸

---

## Step 5: ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ í…ŒìŠ¤íŠ¸

### 5-1. ê´€ë¦¬ì ê¶Œí•œ ì„¤ì •

Supabase Dashboard â†’ **Table Editor** â†’ `profiles` í…Œì´ë¸”ì—ì„œ:
1. ë³¸ì¸ ê³„ì • ì°¾ê¸°
2. `is_admin` ì»¬ëŸ¼ì„ `true`ë¡œ ë³€ê²½
3. Save

### 5-2. ëŒ€ì‹œë³´ë“œ ì ‘ì†

1. http://localhost:3000/admin/stats ì ‘ì†
2. ë¡œê·¸ì¸ í•„ìš”ì‹œ ë¡œê·¸ì¸
3. ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ í™•ì¸

**ì˜ˆìƒ í™”ë©´:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ë°©ë¬¸ì í†µê³„ ëŒ€ì‹œë³´ë“œ      [ê´€ë¦¬ì ì „ìš©] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  ì´ ë°©ë¬¸ì      ì˜¤ëŠ˜ ë°©ë¬¸ì    ì£¼ê°„ í‰ê·  â”‚
â”‚     1              1             1      â”‚
â”‚                                         â”‚
â”‚  ìµœê·¼ 7ì¼ ë°©ë¬¸ì ì¶”ì´                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 2026-01-18    1ëª…    100%      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5-3. ê¶Œí•œ í™•ì¸

- **ê´€ë¦¬ì ê³„ì •**: í†µê³„ ì¡°íšŒ ê°€ëŠ¥
- **ì¼ë°˜ ì‚¬ìš©ì**: "ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤" ë©”ì‹œì§€ í‘œì‹œ
- **ë¹„ë¡œê·¸ì¸ ì‚¬ìš©ì**: ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸

---

## Step 6: ì¤‘ë³µ ë°©ì§€ í…ŒìŠ¤íŠ¸

### 6-1. ì¿ í‚¤ ê¸°ë°˜ ì¤‘ë³µ ë°©ì§€

1. ë¸Œë¼ìš°ì €ì—ì„œ http://localhost:3000 ì ‘ì†
2. ê°œë°œì ë„êµ¬ ì—´ê¸° (F12)
3. Application â†’ Cookies í™•ì¸:
   - `visitor_id`: ë°©ë¬¸ì ê³ ìœ  ID
   - `counted_2026-01-18`: ì˜¤ëŠ˜ ì¹´ìš´íŠ¸ ì—¬ë¶€
   - `session_id`: ì„¸ì…˜ ID

4. í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ (F5)
5. Supabaseì—ì„œ í™•ì¸:
   ```sql
   SELECT * FROM visitor_stats WHERE id = 'total';
   ```
   â†’ `visit_count`ê°€ ì¦ê°€í•˜ì§€ ì•ŠìŒ âœ…

6. ì¿ í‚¤ ì‚­ì œ í›„ ìƒˆë¡œê³ ì¹¨
7. ë‹¤ì‹œ í™•ì¸ â†’ `visit_count` ì¦ê°€ âœ…

### 6-2. ì‹œí¬ë¦¿ ëª¨ë“œ í…ŒìŠ¤íŠ¸

1. ì‹œí¬ë¦¿ ëª¨ë“œë¡œ http://localhost:3000 ì ‘ì†
2. Supabase í™•ì¸ â†’ `visit_count` ì¦ê°€ âœ…
3. ì‹œí¬ë¦¿ ëª¨ë“œì—ì„œ ìƒˆë¡œê³ ì¹¨ â†’ ì¦ê°€í•˜ì§€ ì•ŠìŒ âœ…

---

## Step 7: ë¡œê·¸ í™•ì¸

### 7-1. visitor_logs í…Œì´ë¸” í™•ì¸

```sql
SELECT
  visitor_id,
  page_path,
  referrer,
  visited_at
FROM visitor_logs
ORDER BY visited_at DESC
LIMIT 10;
```

**ì˜ˆìƒ ê²°ê³¼:**
```
visitor_id                            | page_path | referrer | visited_at
--------------------------------------|-----------|----------|------------
a1b2c3d4-...                         | /test     | null     | 2026-01-18 10:30:00
```

### 7-2. ë¶„ì„ìš© ë·° í™•ì¸

**ì‹œê°„ëŒ€ë³„ íŠ¸ë˜í”½**
```sql
SELECT * FROM hourly_traffic LIMIT 5;
```

**ì¸ê¸° í˜ì´ì§€**
```sql
SELECT * FROM popular_pages LIMIT 5;
```

**ìœ ì… ê²½ë¡œ**
```sql
SELECT * FROM referrer_analysis LIMIT 5;
```

---

## ë¬¸ì œ í•´ê²° (Troubleshooting)

### ë¬¸ì œ 1: "Failed to increment count" ì˜¤ë¥˜

**ì›ì¸**: `SUPABASE_SERVICE_KEY`ê°€ ì—†ìŒ

**í•´ê²°**:
1. Supabase Dashboard â†’ Settings â†’ API
2. "Service Role Key" ë³µì‚¬
3. `.env.local`ì— ì¶”ê°€:
   ```bash
   SUPABASE_SERVICE_KEY=eyJ...
   ```
4. ê°œë°œ ì„œë²„ ì¬ì‹œì‘

### ë¬¸ì œ 2: "ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤"

**ì›ì¸**: `is_admin`ì´ `false`

**í•´ê²°**:
1. Supabase Dashboard â†’ Table Editor â†’ `profiles`
2. ë³¸ì¸ ê³„ì •ì˜ `is_admin`ì„ `true`ë¡œ ë³€ê²½

### ë¬¸ì œ 3: "í†µê³„ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"

**ì›ì¸**: ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸”ì´ ì—†ìŒ

**í•´ê²°**:
1. `scripts/setup-visitor-stats.sql` ë‹¤ì‹œ ì‹¤í–‰
2. í…Œì´ë¸” ìƒì„± í™•ì¸:
   ```sql
   SELECT * FROM visitor_stats WHERE id = 'total';
   ```

### ë¬¸ì œ 4: API 404 Not Found

**ì›ì¸**: íŒŒì¼ ê²½ë¡œ ì˜¤ë¥˜

**í•´ê²°**:
1. íŒŒì¼ì´ ì •í™•í•œ ìœ„ì¹˜ì— ìˆëŠ”ì§€ í™•ì¸:
   - `app/api/stats/visitor/route.ts`
   - `app/api/stats/dashboard/route.ts`
2. ê°œë°œ ì„œë²„ ì¬ì‹œì‘

---

## ë‹¤ìŒ ë‹¨ê³„

### ì„ íƒ 1: í”„ë¡ íŠ¸ì—”ë“œì— ì¹´ìš´í„° ì¶”ê°€

í™ˆí˜ì´ì§€ í‘¸í„°ì— "ì´ ë°©ë¬¸ì ìˆ˜: Xëª…" í‘œì‹œí•˜ë ¤ë©´:

1. `app/layout.tsx` ìˆ˜ì •
2. ë‹¤ìŒ ì»´í¬ë„ŒíŠ¸ ì¶”ê°€:
   ```tsx
   'use client'
   import { useEffect, useState } from 'react'

   function VisitorCounter() {
     const [count, setCount] = useState(0)

     useEffect(() => {
       fetch('/api/stats/visitor', { method: 'POST' })
         .then(res => res.json())
         .then(data => setCount(data.count))
     }, [])

     return <span>ì´ ë°©ë¬¸ì: {count.toLocaleString()}ëª…</span>
   }
   ```

### ì„ íƒ 2: Vercel ë°°í¬

```bash
git add .
git commit -m "feat: ë°©ë¬¸ì í†µê³„ ì‹œìŠ¤í…œ ì¶”ê°€"
git push

vercel --prod
```

ë°°í¬ í›„:
1. Vercel Dashboard â†’ Settings â†’ Environment Variables
2. `SUPABASE_SERVICE_KEY` ì¶”ê°€
3. Redeploy

---

## ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] Supabase SQL ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì™„ë£Œ
- [ ] `visitor_stats` í…Œì´ë¸” í™•ì¸
- [ ] `increment_visitor_count` í•¨ìˆ˜ í…ŒìŠ¤íŠ¸ ì™„ë£Œ
- [ ] `.env.local`ì— `SUPABASE_SERVICE_KEY` ì¶”ê°€
- [ ] API ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸ ì™„ë£Œ (`/api/stats/visitor`)
- [ ] ëŒ€ì‹œë³´ë“œ API í…ŒìŠ¤íŠ¸ ì™„ë£Œ (`/api/stats/dashboard`)
- [ ] ê´€ë¦¬ì ê¶Œí•œ ì„¤ì • (`is_admin = true`)
- [ ] ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ ì ‘ì† í™•ì¸ (`/admin/stats`)
- [ ] ì¿ í‚¤ ì¤‘ë³µ ë°©ì§€ ë™ì‘ í™•ì¸
- [ ] `visitor_logs` í…Œì´ë¸”ì— ë¡œê·¸ ì €ì¥ í™•ì¸

---

## ì¶”ê°€ ê¸°ëŠ¥ (í–¥í›„ ê°œì„ )

- [ ] ì°¨íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ (Recharts, Chart.js)
- [ ] í˜ì´ì§€ë³„ ìƒì„¸ í†µê³„
- [ ] ìœ ì… ê²½ë¡œ ë¶„ì„
- [ ] ëª¨ë°”ì¼ vs ë°ìŠ¤í¬í†± ë¹„ìœ¨
- [ ] ì‹¤ì‹œê°„ ë°©ë¬¸ì ìˆ˜ (Supabase Realtime)
- [ ] ì¼ì¼ í†µê³„ ì´ë©”ì¼ ë°œì†¡
- [ ] ë°ì´í„° ì—‘ìŠ¤í¬íŠ¸ (CSV, Excel)

---

**ì™„ë£Œ! ğŸ‰**

ë¬¸ì œê°€ ë°œìƒí•˜ë©´ [docs/specs/08_ë°©ë¬¸ìí†µê³„ì‹œìŠ¤í…œ.md](specs/08_ë°©ë¬¸ìí†µê³„ì‹œìŠ¤í…œ.md)ë¥¼ ì°¸ê³ í•˜ì„¸ìš”.
