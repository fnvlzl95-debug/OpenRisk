# OpenRisk 게시판 기능 구현 계획

> 작성일: 2026-01-06

---

## 요구사항 요약

| 항목 | 내용 |
|------|------|
| 로그인 | 카카오 OAuth |
| 게시판 | 관리자 공지 + 사용자 글 (단일 게시판) |
| 댓글 | 글에 대한 댓글 기능 |
| UI | Skin-B 스타일 (신문 스타일) |

---

## 1. Supabase 사전 설정

### 1.1 카카오 OAuth 설정

1. **Supabase Dashboard** > Authentication > Providers > Kakao 활성화
2. **카카오 개발자 콘솔**에서:
   - REST API 키 복사
   - Redirect URI 추가: `https://[project-id].supabase.co/auth/v1/callback`
3. Supabase에 REST API 키 입력

### 1.2 데이터베이스 테이블 생성

```sql
-- 1. profiles 테이블 (Supabase Auth 연동)
CREATE TABLE public.profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  kakao_id BIGINT UNIQUE,
  nickname TEXT NOT NULL,
  profile_image TEXT,
  is_admin BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 2. posts 테이블
CREATE TABLE public.posts (
  id SERIAL PRIMARY KEY,
  author_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  title TEXT NOT NULL,
  content TEXT NOT NULL,
  is_notice BOOLEAN DEFAULT false,
  view_count INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_posts_created_at ON public.posts(created_at DESC);

-- 3. comments 테이블
CREATE TABLE public.comments (
  id SERIAL PRIMARY KEY,
  post_id INTEGER NOT NULL REFERENCES public.posts(id) ON DELETE CASCADE,
  author_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  content TEXT NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_comments_post_id ON public.comments(post_id);

-- 4. RLS 정책
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.posts ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.comments ENABLE ROW LEVEL SECURITY;

-- profiles: 모두 조회 가능, 본인만 수정
CREATE POLICY "profiles_select" ON public.profiles FOR SELECT USING (true);
CREATE POLICY "profiles_update" ON public.profiles FOR UPDATE USING (auth.uid() = id);

-- posts: 모두 조회, 로그인 유저 작성, 본인만 수정/삭제
CREATE POLICY "posts_select" ON public.posts FOR SELECT USING (true);
CREATE POLICY "posts_insert" ON public.posts FOR INSERT WITH CHECK (auth.uid() = author_id);
CREATE POLICY "posts_update" ON public.posts FOR UPDATE USING (auth.uid() = author_id);
CREATE POLICY "posts_delete" ON public.posts FOR DELETE USING (auth.uid() = author_id);

-- comments: 동일 패턴
CREATE POLICY "comments_select" ON public.comments FOR SELECT USING (true);
CREATE POLICY "comments_insert" ON public.comments FOR INSERT WITH CHECK (auth.uid() = author_id);
CREATE POLICY "comments_update" ON public.comments FOR UPDATE USING (auth.uid() = author_id);
CREATE POLICY "comments_delete" ON public.comments FOR DELETE USING (auth.uid() = author_id);

-- 5. 신규 사용자 프로필 자동 생성 트리거
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.profiles (id, kakao_id, nickname, profile_image)
  VALUES (
    NEW.id,
    (NEW.raw_user_meta_data->>'provider_id')::BIGINT,
    COALESCE(NEW.raw_user_meta_data->>'name', '익명'),
    NEW.raw_user_meta_data->>'avatar_url'
  );
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();
```

---

## 2. 파일 구조

```
lib/
  supabase-auth.ts          # 신규: 인증 클라이언트

app/
  auth/
    callback/route.ts       # OAuth 콜백
  board/
    page.tsx                # 게시판 목록
    write/page.tsx          # 글 작성
    [id]/page.tsx           # 글 상세 + 댓글

  api/board/
    posts/route.ts          # GET 목록, POST 작성
    posts/[id]/route.ts     # GET 상세, PUT 수정, DELETE 삭제
    comments/route.ts       # POST 댓글 작성
    comments/[id]/route.ts  # DELETE 댓글 삭제

components/board/
  AuthButton.tsx            # 카카오 로그인/로그아웃
  PostList.tsx              # 게시글 목록
  PostForm.tsx              # 글 작성/수정 폼
  CommentSection.tsx        # 댓글 목록 + 작성
```

---

## 3. 구현 순서

### Step 1: 패키지 설치
```bash
npm install @supabase/ssr
```

### Step 2: 인증 시스템
- `lib/supabase-auth.ts` 생성
- `app/auth/callback/route.ts` 생성

### Step 3: API 라우트
- `app/api/board/posts/route.ts` (목록, 작성)
- `app/api/board/posts/[id]/route.ts` (상세, 수정, 삭제)
- `app/api/board/comments/route.ts` (댓글 작성)
- `app/api/board/comments/[id]/route.ts` (댓글 삭제)

### Step 4: UI 컴포넌트
- `components/board/AuthButton.tsx`
- `components/board/PostList.tsx`
- `components/board/PostForm.tsx`
- `components/board/CommentSection.tsx`

### Step 5: 페이지
- `app/board/page.tsx` (목록)
- `app/board/write/page.tsx` (작성)
- `app/board/[id]/page.tsx` (상세)

### Step 6: 네비게이션 연동
- 홈페이지에 게시판 링크 추가

---

## 4. 주요 참조 파일

| 파일 | 참조 내용 |
|------|----------|
| `lib/supabase.ts` | 기존 Supabase 클라이언트 패턴 |
| `app/api/feedback/route.ts` | API 라우트 패턴 |
| `components/skin-b/FeedbackModal.tsx` | Skin-B UI 스타일 |
| `app/home-b/page.tsx` | 페이지 레이아웃 |

---

## 5. 관리자 설정

구현 완료 후 Supabase SQL Editor에서 관리자 지정:

```sql
-- 카카오 ID로 관리자 지정
UPDATE public.profiles
SET is_admin = true
WHERE kakao_id = '카카오_고유_ID';
```

---

## 6. UI 디자인 가이드 (Skin-B)

### 색상
- 배경: `#FAFAF8` (크림 화이트)
- 테두리: `border-black` 또는 `border-gray-200`
- 강조: `bg-black text-white`

### 컴포넌트 스타일
```tsx
// 카드/박스
<div className="border-2 border-black bg-white p-4">

// 버튼 (Primary)
<button className="px-4 py-2 bg-black text-white font-bold hover:bg-gray-800">

// 버튼 (Secondary)
<button className="px-4 py-2 border border-black hover:bg-gray-100">

// 뱃지 (공지)
<span className="px-2 py-0.5 bg-black text-white text-[10px] font-bold">
  공지
</span>

// 뱃지 (관리자)
<span className="px-2 py-0.5 border border-black text-[10px]">
  관리자
</span>
```

---

## 7. API 명세

### 게시글 API

| Method | Endpoint | 설명 |
|--------|----------|------|
| GET | `/api/board/posts` | 게시글 목록 (페이지네이션) |
| POST | `/api/board/posts` | 게시글 작성 (인증 필요) |
| GET | `/api/board/posts/[id]` | 게시글 상세 |
| PUT | `/api/board/posts/[id]` | 게시글 수정 (작성자만) |
| DELETE | `/api/board/posts/[id]` | 게시글 삭제 (작성자만) |

### 댓글 API

| Method | Endpoint | 설명 |
|--------|----------|------|
| POST | `/api/board/comments` | 댓글 작성 (인증 필요) |
| DELETE | `/api/board/comments/[id]` | 댓글 삭제 (작성자만) |

### 요청/응답 예시

```typescript
// GET /api/board/posts?page=1
// Response
{
  posts: [
    {
      id: 1,
      title: "공지사항입니다",
      content: "...",
      is_notice: true,
      view_count: 42,
      created_at: "2026-01-06T10:00:00Z",
      author: {
        nickname: "관리자",
        profile_image: "...",
        is_admin: true
      },
      comment_count: 5
    }
  ],
  pagination: {
    page: 1,
    limit: 20,
    total: 100,
    totalPages: 5
  }
}

// POST /api/board/posts
// Request
{
  title: "제목",
  content: "내용",
  isNotice: false  // 관리자만 true 가능
}
```

---

## 8. 보안 및 스팸 방지

### 8.1 입력값 검증 (서버 사이드)

```typescript
// 제목/내용 길이 제한
const LIMITS = {
  title: { min: 2, max: 100 },
  content: { min: 10, max: 10000 },
  comment: { min: 1, max: 1000 },
}

// HTML 태그 제거 (XSS 방지)
const sanitize = (text: string) => text.replace(/<[^>]*>/g, '')
```

### 8.2 Rate Limiting (API 호출 제한)

```typescript
// 사용자별 제한 (Supabase Edge Function 또는 미들웨어)
const RATE_LIMITS = {
  posts: { max: 5, window: '1h' },      // 시간당 게시글 5개
  comments: { max: 20, window: '1h' },  // 시간당 댓글 20개
}
```

### 8.3 스팸 방지

| 방법 | 설명 | 구현 |
|------|------|------|
| 연속 작성 제한 | 같은 내용 연속 등록 방지 | 최근 게시글과 내용 비교 |
| 시간 제한 | 연속 작성 간격 제한 (30초) | created_at 비교 |
| 금칙어 필터 | 욕설/광고 키워드 차단 | 키워드 목록 체크 |
| 링크 제한 | 신규 사용자 링크 포함 제한 | URL 패턴 감지 |

### 8.4 관리자 기능

```sql
-- 사용자 차단 테이블
CREATE TABLE public.blocked_users (
  id SERIAL PRIMARY KEY,
  user_id UUID NOT NULL REFERENCES public.profiles(id),
  reason TEXT,
  blocked_at TIMESTAMPTZ DEFAULT NOW(),
  blocked_until TIMESTAMPTZ  -- NULL이면 영구 차단
);

-- 게시글 신고 테이블
CREATE TABLE public.reports (
  id SERIAL PRIMARY KEY,
  reporter_id UUID NOT NULL REFERENCES public.profiles(id),
  post_id INTEGER REFERENCES public.posts(id),
  comment_id INTEGER REFERENCES public.comments(id),
  reason TEXT NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

### 8.5 RLS 정책 강화

```sql
-- 차단된 사용자는 작성 불가
CREATE POLICY "posts_insert_not_blocked" ON public.posts
FOR INSERT WITH CHECK (
  auth.uid() = author_id
  AND NOT EXISTS (
    SELECT 1 FROM public.blocked_users
    WHERE user_id = auth.uid()
    AND (blocked_until IS NULL OR blocked_until > NOW())
  )
);
```

### 8.6 보안 구현 목록

#### 자동 처리 (프레임워크/라이브러리 제공)
| 항목 | 처리 방식 |
|------|----------|
| CSRF 토큰 검증 | Next.js 기본 제공 |
| SQL Injection 방지 | Supabase SDK 파라미터 바인딩 |
| 기본 XSS 방지 | React JSX 자동 이스케이프 |

#### 직접 구현 필요
| 항목 | 구현 위치 | 설명 |
|------|----------|------|
| 입력값 sanitize | `lib/board/validation.ts` | HTML 태그 제거, 길이 검증 |
| 인증 토큰 검증 | API 라우트 | 모든 POST/PUT/DELETE에서 세션 체크 |
| 권한 검증 | API 라우트 + RLS | 공지글: 관리자만, 수정/삭제: 작성자만 |
| Rate Limiting | 미들웨어 또는 API | 시간당 작성 횟수 제한 |
| 스팸 필터 | `lib/board/spam-filter.ts` | 금칙어, 연속 작성, 링크 제한 |
| 차단 사용자 체크 | RLS + API | blocked_users 테이블 조회 |

#### 구현 체크리스트
- [ ] `lib/board/validation.ts` - sanitize 함수, 길이 검증
- [ ] `lib/board/spam-filter.ts` - 금칙어 목록, 스팸 판정 로직
- [ ] API 라우트에 인증/권한 미들웨어 적용
- [ ] Rate Limiting 미들웨어 (또는 Supabase Edge Function)
- [ ] 신고 기능 UI 및 API

---

## 9. 예상 작업량

| 단계 | 작업 내용 | 파일 수 |
|------|----------|---------|
| Supabase 설정 | OAuth + DB 테이블 | - |
| 인증 시스템 | auth 클라이언트 + 콜백 | 2 |
| API 라우트 | posts + comments CRUD | 4 |
| UI 컴포넌트 | 게시판 관련 | 4 |
| 페이지 | 목록 + 상세 + 작성 | 3 |
| **합계** | | **13개 파일** |
