# OpenRisk 등급 계산 로직

> 최종 업데이트: 2025-01-04
> 버전: v2.1
> 소스: `lib/v2/riskEngine.ts`

---

## 1. 리스크 점수 개요

### 1.1 점수 범위
- **0~100점**: 높을수록 위험
- **정수 반올림**: `Math.round()`

### 1.2 리스크 레벨

| 점수 | 레벨 | 이름 | 설명 |
|------|------|------|------|
| 0~29 | `LOW` | 낮음 | 창업 리스크가 낮은 지역 |
| 30~49 | `MEDIUM` | 보통 | 일반적인 수준의 리스크 |
| 50~69 | `HIGH` | 높음 | 신중한 검토 필요 |
| 70~100 | `VERY_HIGH` | 매우 높음 | 창업 권장하지 않음 |

---

## 2. 종합 점수 계산

### 2.1 계산 공식

```typescript
totalScore =
  (경쟁 점수 × 경쟁 가중치) +
  (임대료 점수 × 임대료 가중치) +
  (생존율 점수 × 생존율 가중치) +
  (유동인구 점수 × 유동인구 가중치) +
  (앵커 점수 × 앵커 가중치) +
  시간대 보정 (±10) +
  상권유형 패널티 (0~15)
```

### 2.2 핵심 함수

```typescript
export function calculateRiskScore(
  category: BusinessCategory,
  metrics: {
    competition: CompetitionMetrics
    traffic: TrafficMetrics
    cost: CostMetrics
    survival: SurvivalMetrics
    anchors: AnchorMetrics
  },
  areaType?: AreaType
): number
```

---

## 3. 지표별 정규화

### 3.1 정규화 기준값

```typescript
const NORMALIZATION = {
  competition: {
    lowThreshold: 5,     // 5개 이하: 낮음
    highThreshold: 15,   // 15개 이상: 높음
  },
  traffic: {
    lowThreshold: 25,    // 25 이하: 낮음 (리스크 높음)
    highThreshold: 80,   // 80 이상: 높음 (리스크 낮음)
    minScore: 20,        // 유동인구 많아도 최소 20점
  },
  cost: {
    lowThreshold: 15,    // 15만원/평 이하: 낮음
    highThreshold: 40,   // 40만원/평 이상: 높음
  },
  survival: {
    lowThreshold: 5,     // 5% 이하: 낮음
    highThreshold: 15,   // 15% 이상: 높음
  },
}
```

### 3.2 경쟁 밀도 정규화

```typescript
function normalizeCompetition(sameCategoryCount: number): number {
  if (sameCategoryCount <= 5) {
    return (sameCategoryCount / 5) * 30  // 0~30점
  }
  if (sameCategoryCount >= 15) {
    return 100  // 100점 고정
  }
  // 5~15개: 30~100점 선형
  return 30 + ((sameCategoryCount - 5) / 10) * 70
}
```

**변환 테이블:**

| 동종 업종 수 | 정규화 점수 |
|-------------|------------|
| 0개 | 0점 |
| 3개 | 18점 |
| 5개 | 30점 |
| 10개 | 65점 |
| 15개+ | 100점 |

### 3.3 임대료 정규화

```typescript
function normalizeCost(avgRent: number): number {
  if (avgRent <= 15) {
    return (avgRent / 15) * 30  // 0~30점
  }
  if (avgRent >= 40) {
    return 100  // 100점 고정
  }
  // 15~40만원: 30~100점 선형
  return 30 + ((avgRent - 15) / 25) * 70
}
```

**변환 테이블:**

| 평당 임대료 | 정규화 점수 |
|------------|------------|
| 10만원 | 20점 |
| 15만원 | 30점 |
| 25만원 | 58점 |
| 40만원+ | 100점 |

### 3.4 생존율(폐업률) 정규화

```typescript
function normalizeSurvival(closureRate: number): number {
  if (closureRate <= 5) {
    return (closureRate / 5) * 30  // 0~30점
  }
  if (closureRate >= 15) {
    return 100  // 100점 고정
  }
  // 5~15%: 30~100점 선형
  return 30 + ((closureRate - 5) / 10) * 70
}
```

**변환 테이블:**

| 폐업률 | 정규화 점수 |
|--------|------------|
| 2% | 12점 |
| 5% | 30점 |
| 10% | 65점 |
| 15%+ | 100점 |

### 3.5 유동인구 정규화 (역방향)

**특징: 유동인구가 많을수록 점수가 낮음 (리스크 낮음)**

```typescript
function normalizeTraffic(estimated: number): number {
  const minScore = 20  // 최소 점수

  if (estimated >= 80) {
    return minScore  // 유동인구 많아도 최소 20점
  }
  if (estimated <= 25) {
    return 100  // 유동인구 적으면 100점
  }
  // 역방향 선형: 25~80 → 100~20
  const range = 100 - minScore  // 80
  return 100 - ((estimated - 25) / 55) * range
}
```

**변환 테이블:**

| 유동 지수 | 정규화 점수 |
|----------|------------|
| 10 | 100점 |
| 25 | 100점 |
| 50 | 56점 |
| 80+ | 20점 |

### 3.6 앵커 시설 정규화

```typescript
function normalizeAnchor(anchors: AnchorMetrics): number {
  if (!anchors.hasAnyAnchor) {
    return 80  // 앵커 없음 = 높은 리스크
  }

  let score = 0

  // 지하철 거리 (가장 중요)
  if (anchors.subway) {
    if (anchors.subway.distance <= 100) score += 0
    else if (anchors.subway.distance <= 300) score += 10
    else if (anchors.subway.distance <= 500) score += 20
    else score += 40
  } else {
    score += 40
  }

  // 스타벅스 (상권 활성화 지표)
  if (anchors.starbucks) {
    if (anchors.starbucks.count >= 3) score += 0
    else if (anchors.starbucks.count >= 1) score += 5
    else score += 10
  } else {
    score += 15
  }

  // 대형마트 (생활권 지표)
  if (!anchors.mart) score += 10

  // 백화점 (프리미엄 지표)
  if (!anchors.department) score += 5

  return Math.min(80, score)
}
```

**점수 구성:**

| 요소 | 조건 | 점수 |
|------|------|------|
| 지하철 | ~100m | 0점 |
| 지하철 | 101~300m | 10점 |
| 지하철 | 301~500m | 20점 |
| 지하철 | 500m+ 또는 없음 | 40점 |
| 스타벅스 | 3개+ | 0점 |
| 스타벅스 | 1~2개 | 5점 |
| 스타벅스 | 0개 | 15점 |
| 대형마트 | 없음 | 10점 |
| 백화점 | 없음 | 5점 |

---

## 4. 업종별 가중치

### 4.1 가중치 구조

```typescript
interface Weights {
  competition: number  // 경쟁 밀도
  cost: number         // 임대료 부담
  survival: number     // 폐업 위험
  traffic: number      // 유동인구
  anchor: number       // 앵커 시설
}
// 합계: 항상 1.0 (100%)
```

### 4.2 음식점 가중치

| 업종 | 경쟁 | 임대료 | 생존 | 유동 | 앵커 |
|------|------|--------|------|------|------|
| 한식 | 0.30 | 0.30 | 0.20 | 0.15 | 0.05 |
| 양식 | 0.25 | 0.25 | 0.20 | 0.25 | 0.05 |
| 일식 | 0.30 | 0.25 | 0.20 | 0.20 | 0.05 |
| 중식 | 0.25 | 0.25 | 0.20 | 0.15 | 0.15 |
| 치킨 | 0.35 | 0.25 | 0.25 | 0.10 | 0.05 |
| 피자 | 0.35 | 0.25 | 0.25 | 0.10 | 0.05 |
| 패스트푸드 | 0.30 | 0.20 | 0.20 | 0.25 | 0.05 |

### 4.3 카페/베이커리 가중치

| 업종 | 경쟁 | 임대료 | 생존 | 유동 | 앵커 |
|------|------|--------|------|------|------|
| 카페 | 0.35 | 0.20 | 0.20 | 0.20 | 0.05 |
| 베이커리 | 0.30 | 0.25 | 0.20 | 0.20 | 0.05 |
| 디저트 | 0.30 | 0.20 | 0.25 | 0.20 | 0.05 |

### 4.4 서비스/기타 가중치

| 업종 | 경쟁 | 임대료 | 생존 | 유동 | 앵커 |
|------|------|--------|------|------|------|
| 편의점 | 0.15 | 0.20 | 0.15 | 0.25 | 0.25 |
| 미용실 | 0.25 | 0.25 | 0.20 | 0.15 | 0.15 |
| 네일샵 | 0.30 | 0.25 | 0.25 | 0.15 | 0.05 |
| 세탁소 | 0.20 | 0.20 | 0.15 | 0.15 | 0.30 |
| 약국 | 0.15 | 0.25 | 0.10 | 0.20 | 0.30 |
| 헬스장 | 0.25 | 0.30 | 0.20 | 0.10 | 0.15 |
| 학원 | 0.25 | 0.25 | 0.20 | 0.10 | 0.20 |
| 술집 | 0.25 | 0.25 | 0.25 | 0.20 | 0.05 |

---

## 5. 보정 점수

### 5.1 시간대 패턴 보정 (±10점)

**업종별 최적 시간대:**

```typescript
const optimalPeakTime = {
  // 낮이 좋은 업종
  restaurant_korean: 'day',
  restaurant_chinese: 'day',
  restaurant_fastfood: 'day',
  bakery: 'day',
  pharmacy: 'day',
  laundry: 'day',

  // 밤이 좋은 업종
  restaurant_western: 'night',
  restaurant_japanese: 'night',
  bar: 'night',
  restaurant_chicken: 'night',
  restaurant_pizza: 'night',
  gym: 'night',
  academy: 'night',

  // 아침이 좋은 업종
  cafe: 'morning',
  convenience: 'morning',
}
```

**보정 로직:**

| 조건 | 보정 점수 |
|------|----------|
| 최적 시간대 일치 | -5점 |
| 시간대 불일치 (기본) | +3점 |
| 주말 업종인데 주말 비중 낮음 | +8점 |
| 주말 업종이고 주말 비중 높음 | -3점 |
| 평일 업종인데 주말 비중 높음 | +8점 |
| 평일 업종이고 평일 중심 | -3점 |

### 5.2 상권 유형 패널티 (0~15점)

```typescript
function getAreaTypePenalty(areaType?: AreaType): number {
  switch (areaType) {
    case 'A_주거': return 0    // 패널티 없음
    case 'B_혼합': return 3    // 약간의 패널티
    case 'C_상업': return 10   // 상업 지역: 높은 경쟁
    case 'D_특수': return 15   // 특수 상권: 시즌 의존
    default: return 0
  }
}
```

---

## 6. 상권 유형 분류

### 6.1 분류 로직

```typescript
export function determineAreaType(
  metrics: { competition, traffic, anchors },
  storeCounts: Record<string, number>
): AreaType
```

### 6.2 분류 기준

**Step 1: 특수 상권 체크**
```typescript
// 주말 비율 50% 이상 → 특수
if (traffic.weekendRatio > 0.5) return 'D_특수'

// 역세권 + 상업 밀집 → 특수
if (subway.distance < 300 && commercialRatio > 0.7) return 'D_특수'
```

**Step 2: 상업 지역 체크**
```typescript
// 유동 지수 30+ AND 상업 점포 60%+ → 상업
if (traffic.index > 30 && commercialRatio > 0.6) return 'C_상업'
```

**Step 3: 주거 지역 체크**
```typescript
// 점포 20개 미만 OR 주거형 점포 40%+ → 주거
if (totalStores < 20 || residentialRatio > 0.4) return 'A_주거'
```

**Step 4: 기본값**
```typescript
return 'B_혼합'  // 나머지는 혼합형
```

### 6.3 업종 분류

**상업형 점포:**
- 음식점 (한식, 양식, 일식, 중식, 치킨, 피자, 패스트푸드)
- 카페, 베이커리, 디저트
- 술집

**주거형 점포:**
- 편의점, 세탁소, 약국
- 슈퍼마켓, 미용실

---

## 7. 계산 예시

### 7.1 예시: 홍대 카페 창업

**입력 데이터:**
```
업종: 카페
동종 업종: 45개
유동 지수: 85
평당 임대료: 42만원
폐업률: 12%
지하철: 홍대입구역 200m
스타벅스: 3개
상권 유형: D_특수
피크타임: night (카페는 morning이 최적)
```

**Step 1: 정규화**
```
경쟁: 45개 → 100점 (15개 이상)
유동: 85 → 20점 (80 이상이면 최소)
임대료: 42만원 → 100점 (40만원 이상)
생존: 12% → 79점
앵커: 200m + 스타벅스 3개 → 10점
```

**Step 2: 가중 합산 (카페 가중치)**
```
= 100 × 0.35 + 100 × 0.20 + 79 × 0.20 + 20 × 0.20 + 10 × 0.05
= 35 + 20 + 15.8 + 4 + 0.5
= 75.3
```

**Step 3: 시간대 보정**
```
카페는 morning 최적, 실제 night → +3점
= 75.3 + 3 = 78.3
```

**Step 4: 상권 유형 패널티**
```
D_특수 → +15점
= 78.3 + 15 = 93.3
```

**Step 5: 범위 클리핑**
```
Math.round(Math.min(100, Math.max(0, 93.3)))
= 93점
```

**결과:**
- 리스크 점수: **93점**
- 리스크 레벨: **VERY_HIGH** (매우 높음)

---

## 8. 레벨 판별 함수

### 8.1 리스크 레벨

```typescript
export function getRiskLevel(score: number): RiskLevel {
  if (score < 30) return 'LOW'
  if (score < 50) return 'MEDIUM'
  if (score < 70) return 'HIGH'
  return 'VERY_HIGH'
}
```

### 8.2 경쟁 밀도 레벨

```typescript
export function getCompetitionLevel(count: number): 'low' | 'medium' | 'high' {
  if (count <= 5) return 'low'
  if (count <= 15) return 'medium'
  return 'high'
}
```

### 8.3 유동인구 레벨

```typescript
export function getTrafficLevel(estimated: number): TrafficLevel {
  if (estimated <= 10) return 'very_low'
  if (estimated <= 25) return 'low'
  if (estimated <= 50) return 'medium'
  if (estimated <= 80) return 'high'
  return 'very_high'
}
```

### 8.4 임대료 레벨

```typescript
export function getCostLevel(avgRent: number): 'low' | 'medium' | 'high' {
  if (avgRent <= 80) return 'low'
  if (avgRent <= 150) return 'medium'
  return 'high'
}
```

### 8.5 생존 리스크 레벨

```typescript
export function getSurvivalRisk(closureRate: number): 'low' | 'medium' | 'high' {
  if (closureRate <= 5) return 'low'
  if (closureRate <= 10) return 'medium'
  return 'high'
}
```

---

## 변경 이력

| 날짜 | 버전 | 변경 내용 |
|------|------|----------|
| 2025-01-04 | v2.1 | 현재 코드 기준 최신화, 계산 예시 추가 |
