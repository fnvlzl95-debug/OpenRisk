# ë°©ë¬¸ì í†µê³„ ì‹œìŠ¤í…œ êµ¬í˜„ ê³„íš

## ê°œìš”

Supabaseì™€ Next.jsë¥¼ í™œìš©í•œ ì¢…í•© ë°©ë¬¸ì í†µê³„ ì‹œìŠ¤í…œì„ êµ¬ì¶•í•©ë‹ˆë‹¤.

### í•µì‹¬ ê¸°ëŠ¥
- ì´ ë°©ë¬¸ì ìˆ˜ + ì¼ë³„ í†µê³„ + ìƒì„¸ ë¡œê·¸ (í˜ì´ì§€ë³„, ì‹œê°„ëŒ€ë³„, ìœ ì…ê²½ë¡œ)
- ì¿ í‚¤ ê¸°ë°˜ ì¤‘ë³µ ë°©ì§€ (í•˜ë£¨ 1íšŒ ì¹´ìš´íŠ¸)
- Slack Bot í†µí•© (5ë¶„ ì„¤ì •, `/stats` ëª…ë ¹ì–´ë¡œ ì¦‰ì‹œ ì¡°íšŒ)
- KakaoTalk Bot í†µí•© (ì„ íƒì‚¬í•­, ëŒ€ì¤‘ ì„œë¹„ìŠ¤ìš©)
- ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ (ì‹œê°í™” ì°¨íŠ¸, íŠ¸ë Œë“œ ë¶„ì„)

### ê¸°ìˆ  ìŠ¤íƒ
- **Database**: Supabase (PostgreSQL) - RPC í•¨ìˆ˜ë¡œ ì›ìì  ì¦ê°€
- **API**: Next.js 16 App Router (Vercel Edge Runtime)
- **Bot**: Slack Slash Commands + KakaoTalk SkillServer
- **Security**: HMAC ê²€ì¦ (Slack), IP í•´ì‹± (ê°œì¸ì •ë³´ ë³´í˜¸)

### ë¹„ìš©
- **ì™„ì „ ë¬´ë£Œ** (Supabase ë¬´ë£Œ í”Œëœ 500MB, 1ë…„ì— 36MBë§Œ ì‚¬ìš©)
- **Vercel ë¬´ë£Œ í‹°ì–´** ì¶©ë¶„ (Edge Functions 10ë§ŒíšŒ/ì›”)

---

## Phase 1: ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„ (Supabase)

### 1.1 ë°©ë¬¸ì í†µê³„ í…Œì´ë¸” ìƒì„±

```sql
-- ì¼ë³„ ë°©ë¬¸ì í†µê³„ ì €ì¥ í…Œì´ë¸”
CREATE TABLE public.visitor_stats (
  id TEXT PRIMARY KEY,              -- í˜•ì‹: 'YYYY-MM-DD' ë˜ëŠ” 'total'
  visit_count INTEGER DEFAULT 0,    -- ì´ ë°©ë¬¸ íšŸìˆ˜
  unique_visitors INTEGER DEFAULT 0, -- ê³ ìœ  ë°©ë¬¸ì ìˆ˜
  last_updated TIMESTAMPTZ DEFAULT NOW(),
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ì´ˆê¸° ì¹´ìš´í„° ìƒì„±
INSERT INTO visitor_stats (id, visit_count, unique_visitors)
VALUES ('total', 0, 0);

-- RLS (Row Level Security) í™œì„±í™”
ALTER TABLE visitor_stats ENABLE ROW LEVEL SECURITY;

-- ì½ê¸° ê¶Œí•œ: ëˆ„êµ¬ë‚˜ ì¡°íšŒ ê°€ëŠ¥
CREATE POLICY "ëˆ„êµ¬ë‚˜ í†µê³„ ì¡°íšŒ ê°€ëŠ¥"
  ON visitor_stats FOR SELECT
  USING (true);

-- ì“°ê¸° ê¶Œí•œ: RPC í•¨ìˆ˜ë¥¼ í†µí•´ì„œë§Œ ê°€ëŠ¥
CREATE POLICY "ì§ì ‘ ì“°ê¸° ë¶ˆê°€"
  ON visitor_stats FOR INSERT
  WITH CHECK (false);
```

### 1.2 ì›ìì  ì¦ê°€ í•¨ìˆ˜ (Race Condition ë°©ì§€)

```sql
-- ë°©ë¬¸ì ìˆ˜ë¥¼ ì•ˆì „í•˜ê²Œ ì¦ê°€ì‹œí‚¤ëŠ” í•¨ìˆ˜
CREATE OR REPLACE FUNCTION increment_visitor_count(
  p_stat_id TEXT DEFAULT 'total'
)
RETURNS INTEGER
LANGUAGE plpgsql
SECURITY DEFINER  -- RLS ìš°íšŒ (ê´€ë¦¬ì ê¶Œí•œ)
AS $$
DECLARE
  v_new_count INTEGER;
BEGIN
  -- Upsert: ì—†ìœ¼ë©´ ìƒì„±, ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸
  INSERT INTO visitor_stats (id, visit_count, unique_visitors, last_updated)
  VALUES (p_stat_id, 1, 1, NOW())
  ON CONFLICT (id) DO UPDATE
  SET
    visit_count = visitor_stats.visit_count + 1,
    last_updated = NOW()
  RETURNING visit_count INTO v_new_count;

  RETURN v_new_count;
END;
$$;
```

### 1.3 ìƒì„¸ ë°©ë¬¸ ë¡œê·¸ í…Œì´ë¸”

```sql
-- í˜ì´ì§€ë³„, ì‹œê°„ëŒ€ë³„ ìƒì„¸ ë°©ë¬¸ ë¡œê·¸
CREATE TABLE public.visitor_logs (
  id BIGSERIAL PRIMARY KEY,
  visitor_id TEXT NOT NULL,         -- ì¿ í‚¤ ê¸°ë°˜ ê³ ìœ  ID
  page_path TEXT,                   -- ë°©ë¬¸ í˜ì´ì§€ (ì˜ˆ: /board/123)
  referrer TEXT,                    -- ìœ ì… ê²½ë¡œ
  user_agent TEXT,                  -- ë¸Œë¼ìš°ì € ì •ë³´
  ip_hash TEXT,                     -- í•´ì‹œëœ IP (ê°œì¸ì •ë³´ ë³´í˜¸)
  session_id TEXT,                  -- ì„¸ì…˜ ID
  visited_at TIMESTAMPTZ DEFAULT NOW()
);

-- ì¸ë±ìŠ¤ ìƒì„± (ë¹ ë¥¸ ì¡°íšŒ)
CREATE INDEX idx_visitor_logs_visitor_id ON visitor_logs(visitor_id);
CREATE INDEX idx_visitor_logs_date ON visitor_logs(visited_at DESC);
CREATE INDEX idx_visitor_logs_page ON visitor_logs(page_path);

-- RLS: ê´€ë¦¬ìë§Œ ì ‘ê·¼
ALTER TABLE visitor_logs ENABLE ROW LEVEL SECURITY;
CREATE POLICY "ê´€ë¦¬ì ì „ìš©"
  ON visitor_logs FOR SELECT
  USING (false);  -- admin clientë¡œë§Œ ì¡°íšŒ ê°€ëŠ¥
```

### 1.4 ë¶„ì„ìš© ë·° (View)

```sql
-- ì‹œê°„ëŒ€ë³„ íŠ¸ë˜í”½ ë¶„ì„
CREATE VIEW hourly_traffic AS
SELECT
  DATE_TRUNC('hour', visited_at) AS hour,
  COUNT(DISTINCT visitor_id) AS unique_visitors,
  COUNT(*) AS total_visits
FROM visitor_logs
WHERE visited_at >= NOW() - INTERVAL '7 days'
GROUP BY DATE_TRUNC('hour', visited_at)
ORDER BY hour DESC;

-- ì¸ê¸° í˜ì´ì§€ ë¶„ì„
CREATE VIEW popular_pages AS
SELECT
  page_path,
  COUNT(DISTINCT visitor_id) AS unique_visitors,
  COUNT(*) AS total_views,
  MAX(visited_at) AS last_visited
FROM visitor_logs
WHERE visited_at >= NOW() - INTERVAL '30 days'
GROUP BY page_path
ORDER BY total_views DESC
LIMIT 50;

-- ìœ ì… ê²½ë¡œ ë¶„ì„
CREATE VIEW referrer_analysis AS
SELECT
  CASE
    WHEN referrer IS NULL THEN 'ì§ì ‘ ë°©ë¬¸'
    WHEN referrer LIKE '%google%' THEN 'Google ê²€ìƒ‰'
    WHEN referrer LIKE '%naver%' THEN 'Naver ê²€ìƒ‰'
    WHEN referrer LIKE '%facebook%' OR referrer LIKE '%instagram%' THEN 'ì†Œì…œ ë¯¸ë””ì–´'
    ELSE referrer
  END AS source,
  COUNT(DISTINCT visitor_id) AS unique_visitors,
  COUNT(*) AS total_visits
FROM visitor_logs
WHERE visited_at >= NOW() - INTERVAL '30 days'
GROUP BY source
ORDER BY total_visits DESC;
```

---

## Phase 2: API êµ¬í˜„

### 2.1 ë°©ë¬¸ì ì¶”ì  API

**íŒŒì¼**: `app/api/stats/visitor/route.ts`

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { createAdminClient } from '@/lib/supabase/admin'
import { createClient } from '@/lib/supabase/server'
import { cookies } from 'next/headers'

export const runtime = 'edge'

// GET: í˜„ì¬ ë°©ë¬¸ì ìˆ˜ ì¡°íšŒ
export async function GET(request: NextRequest) {
  try {
    const supabase = await createClient()
    const { searchParams } = new URL(request.url)
    const statId = searchParams.get('id') || 'total'

    const { data, error } = await supabase
      .from('visitor_stats')
      .select('visit_count, unique_visitors, last_updated')
      .eq('id', statId)
      .single()

    if (error) throw error

    return NextResponse.json({
      success: true,
      stats: data
    })
  } catch (error) {
    return NextResponse.json(
      { success: false, error: 'í†µê³„ ì¡°íšŒ ì‹¤íŒ¨' },
      { status: 500 }
    )
  }
}

// POST: ë°©ë¬¸ì ìˆ˜ ì¦ê°€ + ìƒì„¸ ë¡œê·¸ ì €ì¥
export async function POST(request: NextRequest) {
  try {
    const cookieStore = await cookies()
    const visitorId = cookieStore.get('visitor_id')?.value
    const today = new Date().toISOString().split('T')[0]

    // ìš”ì²­ ì •ë³´ ì¶”ì¶œ
    const body = await request.json().catch(() => ({}))
    const pagePath = body.page_path || request.headers.get('referer') || '/'
    const referrer = request.headers.get('referer')
    const userAgent = request.headers.get('user-agent')
    const sessionId = cookieStore.get('session_id')?.value || crypto.randomUUID()

    // IP í•´ì‹± (ê°œì¸ì •ë³´ ë³´í˜¸)
    const forwarded = request.headers.get('x-forwarded-for')
    const ip = forwarded ? forwarded.split(',')[0] : request.ip || 'unknown'
    const ipHash = ip !== 'unknown'
      ? await crypto.subtle.digest('SHA-256', new TextEncoder().encode(ip))
          .then(buf => Array.from(new Uint8Array(buf))
            .map(b => b.toString(16).padStart(2, '0')).join(''))
      : 'unknown'

    // ì˜¤ëŠ˜ ì´ë¯¸ ì¹´ìš´íŠ¸í–ˆëŠ”ì§€ í™•ì¸
    const alreadyCounted = visitorId && cookieStore.get(`counted_${today}`)?.value === 'true'

    if (alreadyCounted) {
      // ì´ë¯¸ ì¹´ìš´íŠ¸ë¨ - ë¡œê·¸ë§Œ ì €ì¥
      const adminClient = createAdminClient()
      await adminClient.from('visitor_logs').insert({
        visitor_id: visitorId,
        page_path: pagePath,
        referrer,
        user_agent: userAgent,
        ip_hash: ipHash,
        session_id: sessionId
      })

      const supabase = await createClient()
      const { data } = await supabase
        .from('visitor_stats')
        .select('visit_count')
        .eq('id', 'total')
        .single()

      return NextResponse.json({
        success: true,
        counted: false,
        count: data?.visit_count || 0
      })
    }

    // ì¹´ìš´í„° ì¦ê°€
    const adminClient = createAdminClient()

    // ì´ ë°©ë¬¸ì ì¦ê°€
    const { data: totalCount } = await adminClient
      .rpc('increment_visitor_count', { p_stat_id: 'total' })

    // ì¼ë³„ ë°©ë¬¸ì ì¦ê°€
    await adminClient
      .rpc('increment_visitor_count', { p_stat_id: today })

    // ìƒì„¸ ë¡œê·¸ ì €ì¥
    await adminClient.from('visitor_logs').insert({
      visitor_id: visitorId || crypto.randomUUID(),
      page_path: pagePath,
      referrer,
      user_agent: userAgent,
      ip_hash: ipHash,
      session_id: sessionId
    })

    // ì¿ í‚¤ ì„¤ì •
    const response = NextResponse.json({
      success: true,
      counted: true,
      count: totalCount
    })

    const newVisitorId = visitorId || crypto.randomUUID()
    response.cookies.set('visitor_id', newVisitorId, {
      maxAge: 60 * 60 * 24 * 365,  // 1ë…„
      httpOnly: true,
      sameSite: 'lax'
    })

    response.cookies.set('session_id', sessionId, {
      maxAge: 60 * 60 * 24,  // 24ì‹œê°„
      httpOnly: true,
      sameSite: 'lax'
    })

    response.cookies.set(`counted_${today}`, 'true', {
      maxAge: 60 * 60 * 24,  // 24ì‹œê°„
      httpOnly: true,
      sameSite: 'lax'
    })

    return response
  } catch (error) {
    console.error('ë°©ë¬¸ì ì¶”ì  ì˜¤ë¥˜:', error)
    return NextResponse.json(
      { success: false, error: 'ì¹´ìš´íŠ¸ ì¦ê°€ ì‹¤íŒ¨' },
      { status: 500 }
    )
  }
}
```

### 2.2 ëŒ€ì‹œë³´ë“œ API

**íŒŒì¼**: `app/api/stats/dashboard/route.ts`

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { createClient } from '@/lib/supabase/server'

export const runtime = 'edge'

export async function GET(request: NextRequest) {
  try {
    const supabase = await createClient()
    const today = new Date().toISOString().split('T')[0]
    const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]

    // ì´ í†µê³„
    const { data: total } = await supabase
      .from('visitor_stats')
      .select('visit_count, unique_visitors')
      .eq('id', 'total')
      .single()

    // ì˜¤ëŠ˜ í†µê³„
    const { data: todayStats } = await supabase
      .from('visitor_stats')
      .select('visit_count')
      .eq('id', today)
      .single()

    // ì£¼ê°„ í†µê³„
    const { data: weeklyData } = await supabase
      .from('visitor_stats')
      .select('id, visit_count')
      .gte('id', weekAgo)
      .lte('id', today)
      .order('id', { ascending: false })

    return NextResponse.json({
      success: true,
      stats: {
        total: total?.visit_count || 0,
        today: todayStats?.visit_count || 0,
        weekly: weeklyData || []
      }
    })
  } catch (error) {
    return NextResponse.json(
      { success: false, error: 'ëŒ€ì‹œë³´ë“œ ì¡°íšŒ ì‹¤íŒ¨' },
      { status: 500 }
    )
  }
}
```

---

## Phase 3: ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ

### 3.1 í†µê³„ í˜ì´ì§€

**íŒŒì¼**: `app/admin/stats/page.tsx`

```typescript
import { createClient } from '@/lib/supabase/server'
import { redirect } from 'next/navigation'

export default async function StatsPage() {
  const supabase = await createClient()
  const { data: { user } } = await supabase.auth.getUser()

  if (!user) redirect('/auth/login')

  // ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
  const { data: profile } = await supabase
    .from('profiles')
    .select('is_admin')
    .eq('id', user.id)
    .single()

  if (!profile?.is_admin) {
    return <div>ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤</div>
  }

  // í†µê³„ ì¡°íšŒ
  const response = await fetch(`${process.env.NEXT_PUBLIC_SITE_URL}/api/stats/dashboard`, {
    cache: 'no-store'
  })
  const { stats } = await response.json()

  return (
    <div className="container mx-auto p-8">
      <h1 className="text-2xl font-bold mb-6">ë°©ë¬¸ì í†µê³„ ëŒ€ì‹œë³´ë“œ</h1>

      <div className="grid grid-cols-3 gap-4 mb-8">
        <StatCard title="ì´ ë°©ë¬¸ì" value={stats.total} />
        <StatCard title="ì˜¤ëŠ˜ ë°©ë¬¸ì" value={stats.today} />
        <StatCard title="ì£¼ê°„ í‰ê· "
          value={Math.round(stats.weekly.reduce((sum, day) => sum + day.visit_count, 0) / 7)} />
      </div>

      <div className="bg-white rounded shadow p-6">
        <h2 className="text-lg font-semibold mb-4">ìµœê·¼ 7ì¼ ë°©ë¬¸ì ì¶”ì´</h2>
        <table className="w-full">
          <thead>
            <tr className="border-b">
              <th className="text-left py-2">ë‚ ì§œ</th>
              <th className="text-right py-2">ë°©ë¬¸ì ìˆ˜</th>
            </tr>
          </thead>
          <tbody>
            {stats.weekly.map((day) => (
              <tr key={day.id} className="border-b">
                <td className="py-2">{day.id}</td>
                <td className="text-right">{day.visit_count.toLocaleString()}</td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  )
}

function StatCard({ title, value }: { title: string; value: number }) {
  return (
    <div className="bg-white rounded shadow p-6">
      <div className="text-gray-500 text-sm mb-2">{title}</div>
      <div className="text-3xl font-bold text-blue-600">{value.toLocaleString()}</div>
    </div>
  )
}
```

---

## Phase 4: ë´‡ í†µí•©

### 4.1 Slack Bot vs KakaoTalk Bot ë¹„êµ

| í•­ëª© | Slack Bot | KakaoTalk Bot |
|------|-----------|---------------|
| **ì„¤ì • ë‚œì´ë„** | â­ ë§¤ìš° ì‰¬ì›€ (5ë¶„) | â­â­â­â­ ë³µì¡ (1-2ì£¼) |
| **ìŠ¹ì¸ ì ˆì°¨** | ì—†ìŒ (ì¦‰ì‹œ ì‚¬ìš©) | í•„ìˆ˜ (ì‹¬ì‚¬ í•„ìš”) |
| **ê°œë°œì ê³„ì •** | Slack ë¬´ë£Œ ê³„ì • | ì¹´ì¹´ì˜¤ ë¹„ì¦ˆë‹ˆìŠ¤ ê³„ì • |
| **ì‚¬ìš©ì ë²”ìœ„** | íŒ€ ë‚´ë¶€ìš© | ì¼ë°˜ ëŒ€ì¤‘ìš© |
| **í…ŒìŠ¤íŠ¸** | ì¦‰ì‹œ ê°€ëŠ¥ | ì‹¬ì‚¬ í›„ ê°€ëŠ¥ |

**ê²°ë¡ **:
- ì§€ê¸ˆ ë°”ë¡œ ì“°ë ¤ë©´ â†’ Slack Bot
- ëŒ€ì¤‘ ì„œë¹„ìŠ¤ ë§Œë“¤ë ¤ë©´ â†’ KakaoTalk Bot

### 4.2 Slack Bot êµ¬í˜„

#### Step 1: Slack App ìƒì„±

1. https://api.slack.com/apps ì ‘ì†
2. "Create New App" í´ë¦­
3. ì•± ì •ë³´ ì…ë ¥:
   - ì•± ì´ë¦„: OpenRisk Stats Bot
   - ì›Œí¬ìŠ¤í˜ì´ìŠ¤: ë³¸ì¸ì˜ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì„ íƒ

4. Slash Commands ìƒì„±:
   - Command: `/stats`
   - Request URL: `https://your-domain.vercel.app/api/bot/slack`
   - Short Description: ë°©ë¬¸ì í†µê³„ ì¡°íšŒ

5. í™˜ê²½ ë³€ìˆ˜ ì„¤ì •:
   ```bash
   SLACK_BOT_TOKEN=xoxb-...
   SLACK_SIGNING_SECRET=...
   ```

#### Step 2: Slack Bot API êµ¬í˜„

**íŒŒì¼**: `app/api/bot/slack/route.ts`

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { createAdminClient } from '@/lib/supabase/admin'
import crypto from 'crypto'

export const runtime = 'edge'

// Slack ìš”ì²­ ê²€ì¦
function verifySlackRequest(request: NextRequest, body: string): boolean {
  const slackSignature = request.headers.get('x-slack-signature')
  const slackTimestamp = request.headers.get('x-slack-request-timestamp')

  if (!slackSignature || !slackTimestamp) return false

  // Replay attack ë°©ì§€
  const time = Math.floor(Date.now() / 1000)
  if (Math.abs(time - parseInt(slackTimestamp)) > 60 * 5) return false

  // HMAC ê²€ì¦
  const sigBasestring = `v0:${slackTimestamp}:${body}`
  const mySignature = 'v0=' + crypto
    .createHmac('sha256', process.env.SLACK_SIGNING_SECRET!)
    .update(sigBasestring)
    .digest('hex')

  return crypto.timingSafeEqual(
    Buffer.from(mySignature),
    Buffer.from(slackSignature)
  )
}

export async function POST(request: NextRequest) {
  try {
    const bodyText = await request.text()
    const body = new URLSearchParams(bodyText)

    if (!verifySlackRequest(request, bodyText)) {
      return NextResponse.json({ error: 'Invalid signature' }, { status: 403 })
    }

    const command = body.get('command')
    const text = body.get('text')?.trim() || ''

    if (command !== '/stats') {
      return NextResponse.json({ text: 'Unknown command' })
    }

    const adminClient = createAdminClient()
    const today = new Date().toISOString().split('T')[0]

    switch (text) {
      case '':
      case 'total': {
        const { data } = await adminClient
          .from('visitor_stats')
          .select('visit_count, unique_visitors')
          .eq('id', 'total')
          .single()

        return NextResponse.json({
          response_type: 'in_channel',
          blocks: [{
            type: 'section',
            text: {
              type: 'mrkdwn',
              text: `ğŸ“Š *OpenRisk ì´ ë°©ë¬¸ì í†µê³„*\n\nì´ ë°©ë¬¸: *${data?.visit_count.toLocaleString()}íšŒ*\nê³ ìœ  ë°©ë¬¸ì: *${data?.unique_visitors.toLocaleString()}ëª…*`
            }
          }]
        })
      }

      case 'today': {
        const { data } = await adminClient
          .from('visitor_stats')
          .select('visit_count')
          .eq('id', today)
          .single()

        return NextResponse.json({
          response_type: 'in_channel',
          text: `ğŸ“… ì˜¤ëŠ˜ ë°©ë¬¸ì: *${data?.visit_count.toLocaleString()}ëª…*`
        })
      }

      case 'week': {
        const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]
        const { data } = await adminClient
          .from('visitor_stats')
          .select('id, visit_count')
          .gte('id', weekAgo)
          .lte('id', today)
          .order('id', { ascending: false })

        const statsText = data
          ?.map(d => `${d.id}: ${d.visit_count.toLocaleString()}ëª…`)
          .join('\n') || 'ë°ì´í„° ì—†ìŒ'

        return NextResponse.json({
          response_type: 'in_channel',
          blocks: [{
            type: 'section',
            text: {
              type: 'mrkdwn',
              text: `ğŸ“ˆ *ìµœê·¼ 7ì¼ ë°©ë¬¸ì í†µê³„*\n\n\`\`\`\n${statsText}\n\`\`\``
            }
          }]
        })
      }

      default: {
        return NextResponse.json({
          response_type: 'ephemeral',
          text: `ì‚¬ìš©ë²•:\n/stats - ì´ ë°©ë¬¸ì\n/stats today - ì˜¤ëŠ˜\n/stats week - ì£¼ê°„`
        })
      }
    }
  } catch (error) {
    console.error('Slack bot error:', error)
    return NextResponse.json(
      { text: 'âš ï¸ í†µê³„ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' },
      { status: 500 }
    )
  }
}
```

### 4.3 KakaoTalk Bot êµ¬í˜„ (ì„ íƒì‚¬í•­)

#### Step 1: ì¹´ì¹´ì˜¤ ê°œë°œì ê³„ì • ì„¤ì •

1. https://developers.kakao.com ì ‘ì†
2. ì• í”Œë¦¬ì¼€ì´ì…˜ ë“±ë¡
3. ì¹´ì¹´ì˜¤í†¡ ì±„ë„ ìƒì„± (https://center-pf.kakao.com)
4. ì±—ë´‡ ìƒì„± ë° ì‹¬ì‚¬ ì œì¶œ (3-7ì¼ ì†Œìš”)
5. SkillServer URL ë“±ë¡

#### Step 2: í™˜ê²½ ë³€ìˆ˜ ì„¤ì •

```bash
KAKAO_REST_API_KEY=...
KAKAO_JAVASCRIPT_KEY=...
KAKAO_CHANNEL_ID=@openrisk-stats
```

#### Step 3: KakaoTalk Bot API êµ¬í˜„

**íŒŒì¼**: `app/api/bot/kakao/route.ts`

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { createAdminClient } from '@/lib/supabase/admin'

export const runtime = 'edge'

interface KakaoSkillResponse {
  version: '2.0'
  template: {
    outputs: Array<{
      simpleText?: { text: string }
      basicCard?: {
        title: string
        description: string
        buttons?: Array<{
          action: 'webLink' | 'message'
          label: string
          webLinkUrl?: string
          messageText?: string
        }>
      }
    }>
  }
}

export async function POST(request: NextRequest) {
  try {
    const body = await request.json()
    const utterance = body.userRequest?.utterance || ''
    const adminClient = createAdminClient()
    const today = new Date().toISOString().split('T')[0]

    if (utterance.includes('ì´') || utterance.includes('ì „ì²´')) {
      const { data } = await adminClient
        .from('visitor_stats')
        .select('visit_count, unique_visitors')
        .eq('id', 'total')
        .single()

      const response: KakaoSkillResponse = {
        version: '2.0',
        template: {
          outputs: [{
            basicCard: {
              title: 'ğŸ“Š OpenRisk ë°©ë¬¸ì í†µê³„',
              description: `ì´ ë°©ë¬¸: ${data?.visit_count.toLocaleString()}íšŒ\nê³ ìœ  ë°©ë¬¸ì: ${data?.unique_visitors.toLocaleString()}ëª…`,
              buttons: [
                {
                  action: 'message',
                  label: 'ì˜¤ëŠ˜ í†µê³„ ë³´ê¸°',
                  messageText: 'ì˜¤ëŠ˜ ë°©ë¬¸ì'
                },
                {
                  action: 'webLink',
                  label: 'ì‚¬ì´íŠ¸ ë°©ë¬¸',
                  webLinkUrl: 'https://your-domain.vercel.app'
                }
              ]
            }
          }]
        }
      }
      return NextResponse.json(response)
    }

    if (utterance.includes('ì˜¤ëŠ˜')) {
      const { data } = await adminClient
        .from('visitor_stats')
        .select('visit_count')
        .eq('id', today)
        .single()

      const response: KakaoSkillResponse = {
        version: '2.0',
        template: {
          outputs: [{
            simpleText: {
              text: `ğŸ“… ì˜¤ëŠ˜ ë°©ë¬¸ì: ${data?.visit_count.toLocaleString()}ëª…`
            }
          }]
        }
      }
      return NextResponse.json(response)
    }

    // ê¸°ë³¸ ì‘ë‹µ
    const response: KakaoSkillResponse = {
      version: '2.0',
      template: {
        outputs: [{
          simpleText: {
            text: 'ë‹¤ìŒê³¼ ê°™ì´ ë¬¼ì–´ë³´ì„¸ìš”:\n\nâ€¢ ì´ ë°©ë¬¸ì\nâ€¢ ì˜¤ëŠ˜ ë°©ë¬¸ì\nâ€¢ ì´ë²ˆ ì£¼ ë°©ë¬¸ì'
          }
        }]
      }
    }
    return NextResponse.json(response)

  } catch (error) {
    console.error('KakaoTalk bot error:', error)
    return NextResponse.json({
      version: '2.0',
      template: {
        outputs: [{
          simpleText: { text: 'âš ï¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }
        }]
      }
    }, { status: 500 })
  }
}
```

---

## í™˜ê²½ ë³€ìˆ˜ ì„¤ì •

```bash
# .env.local

# Supabase (í•„ìˆ˜)
NEXT_PUBLIC_SUPABASE_URL=https://[í”„ë¡œì íŠ¸].supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJ...
SUPABASE_SERVICE_KEY=eyJ...

# Slack Bot (ì„ íƒ)
SLACK_BOT_TOKEN=xoxb-...
SLACK_SIGNING_SECRET=...

# KakaoTalk Bot (ì„ íƒ)
KAKAO_REST_API_KEY=...
KAKAO_JAVASCRIPT_KEY=...
KAKAO_CHANNEL_ID=@openrisk-stats

# ì‚¬ì´íŠ¸ URL
NEXT_PUBLIC_SITE_URL=https://your-domain.vercel.app
```

---

## ê²€ì¦ ì²´í¬ë¦¬ìŠ¤íŠ¸

### ë°ì´í„°ë² ì´ìŠ¤ ê²€ì¦
```sql
-- í…Œì´ë¸” ì¡´ì¬ í™•ì¸
SELECT * FROM visitor_stats WHERE id = 'total';

-- RPC í•¨ìˆ˜ í…ŒìŠ¤íŠ¸
SELECT increment_visitor_count('test-2026-01-18');

-- ì¦ê°€ í™•ì¸
SELECT * FROM visitor_stats WHERE id = 'test-2026-01-18';
```

### API í…ŒìŠ¤íŠ¸
```bash
# GET ìš”ì²­
curl https://your-domain.vercel.app/api/stats/visitor

# POST ìš”ì²­ (ì¹´ìš´íŠ¸ ì¦ê°€)
curl -X POST https://your-domain.vercel.app/api/stats/visitor

# ëŒ€ì‹œë³´ë“œ
curl https://your-domain.vercel.app/api/stats/dashboard
```

### Slack Bot í…ŒìŠ¤íŠ¸
1. Slackì—ì„œ `/stats` ì…ë ¥
2. `/stats today` ì…ë ¥
3. `/stats week` ì…ë ¥

### ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ
1. ê´€ë¦¬ì ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸
2. `/admin/stats` ì ‘ì†
3. ì´/ì˜¤ëŠ˜/ì£¼ê°„ í†µê³„ í™•ì¸

---

## ì„±ëŠ¥ ê³ ë ¤ì‚¬í•­

### Supabase vs Redis ë¹„êµ

| í•­ëª© | Supabase | Redis (Upstash) |
|------|----------|-----------------|
| ì‘ë‹µ ì†ë„ | 10-50ms | 1-5ms |
| ë°ì´í„° ì˜ì†ì„± | âœ… ì˜êµ¬ ì €ì¥ | âš ï¸ íœ˜ë°œ ê°€ëŠ¥ |
| ë³µì¡í•œ ì¿¼ë¦¬ | âœ… SQL ê°€ëŠ¥ | âŒ Key-Valueë§Œ |
| ë¹„ìš© | âœ… ë¬´ë£Œ 500MB | ì œí•œì  ë¬´ë£Œ |
| ê´€ë¦¬ ë³µì¡ë„ | âœ… ë‹¨ìˆœ | âš ï¸ ë™ê¸°í™” í•„ìš” |

**ê²°ë¡ **:
- Supabase ì‚¬ìš© ì´ìœ :
  1. ì‚¬ìš©ìëŠ” 10-50msì™€ 1-5msë¥¼ êµ¬ë¶„ ëª»í•¨
  2. ì´ë¯¸ ì—°ê²°ë˜ì–´ ìˆì–´ ì¶”ê°€ ì„¤ì • ë¶ˆí•„ìš”
  3. ë°ì´í„° ì•ˆì „ì„± ë³´ì¥
  4. ìƒì„¸ ë¶„ì„ ì¿¼ë¦¬ ê°€ëŠ¥
  5. ë¬´ë£Œ í‹°ì–´ë¡œ ì¶©ë¶„

### DB ìš©ëŸ‰ ê³„ì‚°

- **ì´ ë°©ë¬¸ìë§Œ**: 1ê°œ row (ìˆ˜ì‹­ bytes)
- **ì¼ë³„ í†µê³„**: 365ê°œ row/ë…„ (ìˆ˜ì‹­ KB/ë…„)
- **ìƒì„¸ ë¡œê·¸**: í•˜ë£¨ 1000ëª… ë°©ë¬¸ ì‹œ ì•½ 100KB/ì¼ â†’ 1ë…„ì— 36MB

**Supabase ë¬´ë£Œ í”Œëœ (500MB)ìœ¼ë¡œ ìˆ˜ë…„ê°„ ì‚¬ìš© ê°€ëŠ¥**

---

## êµ¬í˜„ ì˜ˆìƒ ì‹œê°„

| ë‹¨ê³„ | ì†Œìš” ì‹œê°„ |
|------|----------|
| Database ì„¤ì • | 10ë¶„ |
| API êµ¬í˜„ | 30ë¶„ |
| Admin Dashboard | 30ë¶„ |
| Slack Bot ì„¤ì • + êµ¬í˜„ | 20ë¶„ |
| **ì´í•©** | **~1.5ì‹œê°„** |

---

## ìƒì„±í•  íŒŒì¼

1. `app/api/stats/visitor/route.ts` - ë°©ë¬¸ì ì¶”ì  API
2. `app/api/stats/dashboard/route.ts` - ëŒ€ì‹œë³´ë“œ API
3. `app/api/bot/slack/route.ts` - Slack ë´‡
4. `app/api/bot/kakao/route.ts` - ì¹´ì¹´ì˜¤í†¡ ë´‡ (ì„ íƒ)
5. `app/admin/stats/page.tsx` - ê´€ë¦¬ì í˜ì´ì§€

---

## í–¥í›„ ê°œì„  ì‚¬í•­

1. **ì‹¤ì‹œê°„ ëŒ€ì‹œë³´ë“œ**: Supabase Realtime êµ¬ë…ìœ¼ë¡œ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
2. **ë°ì´í„° ì‹œê°í™”**: Chart.js ë˜ëŠ” Rechartsë¡œ ê·¸ë˜í”„ ì¶”ê°€
3. **ê³ ê¸‰ ë¶„ì„**:
   - ëª¨ë°”ì¼ vs ë°ìŠ¤í¬í†± ë¹„ìœ¨
   - ì§€ì—­ë³„ ë°©ë¬¸ì ë¶„ì„
   - ì²´ë¥˜ ì‹œê°„ ì¶”ì 
4. **ì•Œë¦¼ ê¸°ëŠ¥**: ì¼ì¼ í†µê³„ë¥¼ Slack/ì´ë©”ì¼ë¡œ ìë™ ì „ì†¡
5. **ë°ì´í„° ë³´ê´€**: 90ì¼ ì´ìƒ ëœ ë¡œê·¸ ìë™ ì‚­ì œ (Vercel Cron Job)

---

## ì°¸ê³  ìë£Œ

- [Supabase RPC Functions](https://supabase.com/docs/guides/database/functions)
- [Next.js App Router](https://nextjs.org/docs/app)
- [Slack API Documentation](https://api.slack.com/docs)
- [Kakao Developers](https://developers.kakao.com/)
- [Vercel Edge Functions](https://vercel.com/docs/functions/edge-functions)
